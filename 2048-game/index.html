<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>2048 ‚Äî –ü—Ä–æ—Å—Ç–∞—è –∏–≥—Ä–∞</title>
<style>
:root {
  --bg-primary: #f5e6d3;
  --bg-secondary: #e6d5c1;
  --cell-bg: #d4c4b0;
  --tile-2: #f0e5d3;
  --tile-4: #e6d5c1;
  --tile-8: #d4c4b0;
  --tile-16: #c5b49c;
  --tile-32: #b8a68a;
  --tile-64: #ab9678;
  --tile-128: #9e8666;
  --tile-256: #917654;
  --tile-512: #846642;
  --tile-1024: #775630;
  --tile-2048: #6b4620;
  --text-dark: #4a3c28;
  --text-light: #f5e6d3;
  --accent: #8b7355;
  --shadow: rgba(0,0,0,0.1);
}

/* –¢–µ–º—ã */
.theme-dark {
  --bg-primary: #2d2d2d;
  --bg-secondary: #3a3a3a;
  --cell-bg: #2a2a2a;
  --tile-2: #4a4a4a;
  --tile-4: #5a5a5a;
  --tile-8: #6a6a6a;
  --tile-16: #7a7a7a;
  --tile-32: #8a8a8a;
  --tile-64: #9a9a9a;
  --tile-128: #8b7355;
  --tile-256: #9d8567;
  --tile-512: #af9779;
  --tile-1024: #c1a98b;
  --tile-2048: #d3bb9d;
  --text-dark: #f0e6d3;
  --text-light: #2d2d2d;
  --accent: #d3bb9d;
}

.theme-ocean {
  --bg-primary: #e0f2f1;
  --bg-secondary: #b2ebf2;
  --cell-bg: #a5d6d6;
  --tile-2: #80deea;
  --tile-4: #4dd0e1;
  --tile-8: #26c6da;
  --tile-16: #00bcd4;
  --tile-32: #00acc1;
  --tile-64: #0097a7;
  --tile-128: #00838f;
  --tile-256: #006064;
  --tile-512: #004d40;
  --tile-1024: #00695c;
  --tile-2048: #00796b;
  --text-dark: #004d40;
  --text-light: #e0f2f1;
  --accent: #00838f;
}

.theme-forest {
  --bg-primary: #e8f5e8;
  --bg-secondary: #c8e6c9;
  --cell-bg: #a5d6a7;
  --tile-2: #a5d6a7;
  --tile-4: #81c784;
  --tile-8: #66bb6a;
  --tile-16: #4caf50;
  --tile-32: #43a047;
  --tile-64: #388e3c;
  --tile-128: #2e7d32;
  --tile-256: #1b5e20;
  --tile-512: #2e7d32;
  --tile-1024: #388e3c;
  --tile-2048: #4caf50;
  --text-dark: #1b5e20;
  --text-light: #e8f5e8;
  --accent: #4caf50;
}

* { 
  box-sizing: border-box; 
  margin: 0; 
  padding: 0; 
}

html, body {
  /* –ó–∞–ø—Ä–µ—â–∞–µ–º –ª—é–±–æ–π —Å–∫—Ä–æ–ª–ª –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
  overflow: hidden;
  height: 100%;
  overscroll-behavior: none;
  -webkit-overflow-scrolling: auto;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background: var(--bg-primary);
  color: var(--text-dark);
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
  transition: background 0.3s ease;
  /* –ü–æ–ª–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ touch actions */
  touch-action: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
  -webkit-tap-highlight-color: transparent;
}

.container {
  width: 100%;
  max-width: 500px;
  text-align: center;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  gap: 10px;
}

/* –û–±—ä–µ–º–Ω—ã–π 3D –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
h1 {
  font-size: 52px;
  font-weight: 700;
  color: var(--accent);
  text-shadow: 
    0 2px 0 rgba(0,0,0,0.25),
    0 4px 0 rgba(0,0,0,0.15),
    0 6px 0 rgba(0,0,0,0.1),
    0 8px 8px var(--shadow);
  transform: perspective(500px) rotateX(15deg);
  /* –ó–∞–ø—Ä–µ—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
  -webkit-user-select: none;
  user-select: none;
}

@media (max-width: 480px) {
  h1 { font-size: 40px; }
}

.score-container {
  display: flex;
  gap: 10px;
}

.score-box {
  background: var(--bg-secondary);
  padding: 10px 16px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
}

.score-value {
  font-size: 20px;
  font-weight: 700;
  display: block;
}

.controls {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  justify-content: center;
  flex-wrap: wrap;
}

button {
  background: var(--accent);
  color: var(--text-light);
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, opacity 0.2s;
  -webkit-tap-highlight-color: transparent;
}

button:active {
  transform: scale(0.95);
}

select {
  background: var(--bg-secondary);
  color: var(--text-dark);
  border: 2px solid var(--accent);
  padding: 10px;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
}

.board-container {
  background: var(--bg-secondary);
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 4px 16px var(--shadow);
  width: 100%;
  max-width: 460px;
  margin: 0 auto 15px;
  position: relative;
  /* –ö—Ä–∏—Ç–∏—á–Ω–æ: –æ—Ç–∫–ª—é—á–∞–µ–º –ª—é–±—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∂–µ—Å—Ç—ã */
  touch-action: none;
  -webkit-user-select: none;
  user-select: none;
}

.board {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows: repeat(4, 1fr);
  /* –í–û–ó–í–†–ê–©–ê–ï–ú gap, –Ω–æ —É–±–∏—Ä–∞–µ–º cell-bg —ç–ª–µ–º–µ–Ω—Ç—ã */
  gap: 10px;
  width: 100%;
  aspect-ratio: 1;
  position: relative;
  background: var(--cell-bg);
  padding: 10px;
  border-radius: 8px;
}

/* –ü–ª–∏—Ç–∫–∏ */
.tile {
  /* –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ grid */
  position: relative;
  width: 100%;
  height: 100%;
  background: var(--tile-bg);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  font-weight: 700;
  color: var(--text-dark);
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  -webkit-user-select: none;
  user-select: none;
  border: 2px solid var(--bg-primary);
  box-shadow: 0 4px 8px var(--shadow), inset 0 -2px 0 rgba(0,0,0,0.05);
  z-index: 2;
  /* Grid –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ */
  grid-column: var(--col);
  grid-row: var(--row);
}

.tile.new {
  animation: fadeIn 0.2s ease;
}

.tile.merged {
  animation: pop 0.2s ease;
}

@keyframes fadeIn {
  0% { opacity: 0; transform: scale(0.5); }
  100% { opacity: 1; transform: scale(1); }
}

@keyframes pop {
  0% { transform: scale(0.8); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.tile.v2 { background: var(--tile-2); }
.tile.v4 { background: var(--tile-4); }
.tile.v8 { background: var(--tile-8); color: var(--text-light); }
.tile.v16 { background: var(--tile-16); color: var(--text-light); }
.tile.v32 { background: var(--tile-32); color: var(--text-light); }
.tile.v64 { background: var(--tile-64); color: var(--text-light); }
.tile.v128 { background: var(--tile-128); color: var(--text-light); font-size: 28px; }
.tile.v256 { background: var(--tile-256); color: var(--text-light); font-size: 28px; }
.tile.v512 { background: var(--tile-512); color: var(--text-light); font-size: 28px; }
.tile.v1024 { background: var(--tile-1024); color: var(--text-light); font-size: 24px; }
.tile.v2048 { background: var(--tile-2048); color: var(--text-light); font-size: 24px; animation: pulse 1s infinite; }

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(139, 115, 85, 0.7); }
  50% { box-shadow: 0 0 0 10px rgba(139, 115, 85, 0); }
}

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.overlay.active {
  display: flex;
}

.modal {
  background: var(--bg-primary);
  padding: 40px;
  border-radius: 16px;
  text-align: center;
  max-width: 90%;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal h2 {
  font-size: 36px;
  margin-bottom: 20px;
  color: var(--accent);
}

.modal button {
  margin-top: 20px;
  font-size: 16px;
  padding: 12px 30px;
}

/* –ö–Ω–æ–ø–∫–∞ Shuffle */
.shuffle-btn {
  background: linear-gradient(135deg, #9c27b0, #7b1fa2);
  margin: 15px auto 0;
  font-size: 16px;
  padding: 12px 30px;
  display: block;
  position: relative;
  overflow: hidden;
}

.shuffle-btn::before {
  content: 'üîÄ';
  margin-right: 8px;
  font-size: 18px;
}

/* –ú–æ–±–∏–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ */
@media (max-width: 480px) {
  .tile {
    font-size: 24px;
  }
  
  .tile.v128, .tile.v256, .tile.v512 {
    font-size: 20px;
  }
  
  .tile.v1024, .tile.v2048 {
    font-size: 16px;
  }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>2048</h1>
    <div class="score-container">
      <div class="score-box">
        –°—á—ë—Ç: <span class="score-value" id="score">0</span>
      </div>
      <div class="score-box">
        –õ—É—á—à–∏–π: <span class="score-value" id="best">0</span>
      </div>
    </div>
  </div>
  
  <div class="controls">
    <button id="new-game">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    <select id="theme-select">
      <option value="beige">–ë–µ–∂–µ–≤—ã–π</option>
      <option value="dark">–¢—ë–º–Ω—ã–π</option>
      <option value="ocean">–û–∫–µ–∞–Ω</option>
      <option value="forest">–õ–µ—Å</option>
    </select>
  </div>
  
  <div class="board-container">
    <div class="board" id="board"></div>
  </div>
  
  <button class="shuffle-btn" id="shuffle-btn">Shuffle</button>
</div>

<div class="overlay" id="game-over">
  <div class="modal">
    <h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
    <p>–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á—ë—Ç: <span id="final-score">0</span></p>
    <button id="restart">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
  </div>
</div>

<div class="overlay" id="victory">
  <div class="modal">
    <h2>üéâ –ü–æ–±–µ–¥–∞! üéâ</h2>
    <p>–í—ã —Å–æ–±—Ä–∞–ª–∏ 2048!</p>
    <p>–°—á—ë—Ç: <span id="victory-score">0</span></p>
    <button id="continue">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
  </div>
</div>

<script>
// ==================== –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
const BOARD_SIZE = 4;
const board = document.getElementById('board');
const BOARD_CONTAINER = document.querySelector('.board-container');
const scoreEl = document.getElementById('score');
const bestEl = document.getElementById('best');
const newGameBtn = document.getElementById('new-game');
const shuffleBtn = document.getElementById('shuffle-btn');
const themeSelect = document.getElementById('theme-select');
const gameOverOverlay = document.getElementById('game-over');
const victoryOverlay = document.getElementById('victory');
const finalScoreEl = document.getElementById('final-score');
const victoryScoreEl = document.getElementById('victory-score');

let grid = [];
let score = 0;
let best = parseInt(localStorage.getItem('bestScore') || '0', 10);
let hasWon = false;

// –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ª—É—á—à–∏–π —Å—á—ë—Ç
bestEl.textContent = best;

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
/**
 * –°–æ–∑–¥–∞—ë—Ç –ø—É—Å—Ç—É—é –∏–≥—Ä–æ–≤—É—é —Å–µ—Ç–∫—É
 */
function initGrid() {
  grid = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
}

/**
 * –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é –ø–ª–∏—Ç–∫—É (2 –∏–ª–∏ 4) –≤ —Å–ª—É—á–∞–π–Ω—É—é –ø—É—Å—Ç—É—é –∫–ª–µ—Ç–∫—É
 * @returns {boolean} –£–¥–∞–ª–æ—Å—å –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –ø–ª–∏—Ç–∫—É
 */
function addTile() {
  const emptyCells = [];
  for (let r = 0; r < BOARD_SIZE; r++) {
    for (let c = 0; c < BOARD_SIZE; c++) {
      if (grid[r][c] === 0) emptyCells.push([r, c]);
    }
  }
  
  if (emptyCells.length === 0) return false;
  
  const [row, col] = emptyCells[Math.floor(Math.random() * emptyCells.length)];
  grid[row][col] = { value: Math.random() < 0.9 ? 2 : 4, id: Date.now() };
  return true;
}

// ==================== –†–ï–ù–î–ï–†–ò–ù–ì ====================
/**
 * –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ —Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏
 * –ü–ª–∏—Ç–∫–∏ —Ç–µ–ø–µ—Ä—å –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ CSS Grid, –∞ –Ω–µ absolute
 */
function render() {
  // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –ø–ª–∏—Ç–∫–∏
  const oldTiles = board.querySelectorAll('.tile');
  oldTiles.forEach(tile => tile.remove());
  
  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–ª–∏—Ç–∫–∏
  for (let r = 0; r < BOARD_SIZE; r++) {
    for (let c = 0; c < BOARD_SIZE; c++) {
      const cell = grid[r][c];
      if (cell !== 0) {
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.textContent = cell.value;
        tile.classList.add(`v${cell.value}`);
        tile.dataset.id = cell.id;
        
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –≤ grid —á–µ—Ä–µ–∑ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        tile.style.setProperty('--col', c + 1);
        tile.style.setProperty('--row', r + 1);
        
        board.appendChild(tile);
      }
    }
  }
}

// ==================== –õ–û–ì–ò–ö–ê –î–í–ò–ñ–ï–ù–ò–Ø ====================
/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ –ø–ª–∏—Ç–æ–∫ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
 * @param {string} direction - 'up', 'down', 'left', 'right'
 * @returns {boolean} –ë—ã–ª –ª–∏ —Å–¥–µ–ª–∞–Ω —Ö–æ–¥
 */
function move(direction) {
  let moved = false;
  
  if (direction === 'left' || direction === 'right') {
    for (let r = 0; r < BOARD_SIZE; r++) {
      let row = grid[r].filter(cell => cell !== 0);
      if (direction === 'right') row.reverse();
      
      // –°–ª–∏—è–Ω–∏–µ
      for (let i = 0; i < row.length - 1; i++) {
        if (row[i].value === row[i + 1].value) {
          row[i].value *= 2;
          score += row[i].value;
          row.splice(i + 1, 1);
          moved = true;
        }
      }
      
      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –∫–ª–µ—Ç–æ–∫
      while (row.length < BOARD_SIZE) row.push(0);
      if (direction === 'right') row.reverse();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º grid
      grid[r] = row.map((cell, index) => 
        cell !== 0 ? { value: cell.value, id: Date.now() + r * BOARD_SIZE + index } : 0
      );
    }
  } else {
    for (let c = 0; c < BOARD_SIZE; c++) {
      let column = grid.map(row => row[c]).filter(cell => cell !== 0);
      if (direction === 'down') column.reverse();
      
      // –°–ª–∏—è–Ω–∏–µ
      for (let i = 0; i < column.length - 1; i++) {
        if (column[i].value === column[i + 1].value) {
          column[i].value *= 2;
          score += column[i].value;
          column.splice(i + 1, 1);
          moved = true;
        }
      }
      
      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –∫–ª–µ—Ç–æ–∫
      while (column.length < BOARD_SIZE) column.push(0);
      if (direction === 'down') column.reverse();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º grid
      column.forEach((cell, index) => {
        const r = index;
        if (cell !== 0) {
          grid[r][c] = { value: cell.value, id: Date.now() + r * BOARD_SIZE + c };
        } else {
          grid[r][c] = 0;
        }
      });
    }
  }
  
  return moved;
}

/**
 * –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è –ø–ª–∏—Ç–æ–∫ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
 */
function shuffleWithAnimation() {
  const tiles = [];
  const positions = [];
  
  // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–ª–∏—Ç–∫–∏
  for (let r = 0; r < BOARD_SIZE; r++) {
    for (let c = 0; c < BOARD_SIZE; c++) {
      if (grid[r][c] !== 0) {
        tiles.push({ ...grid[r][c] });
        positions.push([r, c]);
      }
    }
  }
  
  if (tiles.length < 2) return; // –ù–µ—á–µ–≥–æ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞—Ç—å
  
  // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏
  for (let i = positions.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [positions[i], positions[j]] = [positions[j], positions[i]];
  }
  
  // –û—á–∏—â–∞–µ–º grid
  const newGrid = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
  
  // –†–∞–∑–º–µ—â–∞–µ–º –ø–ª–∏—Ç–∫–∏ –Ω–∞ –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö
  tiles.forEach((tile, index) => {
    const [newR, newC] = positions[index];
    newGrid[newR][newC] = { value: tile.value, id: Date.now() + Math.random() };
  });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º grid –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
  grid = newGrid;
  render();
}

// ==================== –ü–†–û–í–ï–†–ö–ò –°–û–°–¢–û–Ø–ù–ò–Ø ====================
/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤–æ–∑–º–æ–∂–µ–Ω –ª–∏ —Ö–æ–¥
 * @returns {boolean} –í–æ–∑–º–æ–∂–µ–Ω –ª–∏ —Ö–æ–¥
 */
function canMove() {
  for (let r = 0; r < BOARD_SIZE; r++) {
    for (let c = 0; c < BOARD_SIZE; c++) {
      if (grid[r][c] === 0) return true;
    }
  }
  
  for (let r = 0; r < BOARD_SIZE; r++) {
    for (let c = 0; c < BOARD_SIZE - 1; c++) {
      if (grid[r][c] !== 0 && grid[r][c + 1] !== 0 && 
          grid[r][c].value === grid[r][c + 1].value) return true;
    }
  }
  
  for (let r = 0; r < BOARD_SIZE - 1; r++) {
    for (let c = 0; c < BOARD_SIZE; c++) {
      if (grid[r][c] !== 0 && grid[r + 1][c] !== 0 && 
          grid[r][c].value === grid[r + 1][c].value) return true;
    }
  }
  
  return false;
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏–µ –ø–æ–±–µ–¥—ã (–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ 2048)
 * @returns {boolean} –î–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ –ª–∏ –ø–æ–±–µ–¥–∞
 */
function checkWin() {
  for (let r = 0; r < BOARD_SIZE; r++) {
    for (let c = 0; c < BOARD_SIZE; c++) {
      if (grid[r][c] !== 0 && grid[r][c].value === 2048 && !hasWon) {
        hasWon = true;
        victoryScoreEl.textContent = score;
        victoryOverlay.classList.add('active');
        return true;
      }
    }
  }
  return false;
}

// ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ì–†–û–ô ====================
/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ö–æ–¥ –∏–≥—Ä–æ–∫–∞
 * @param {string} direction - –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è
 */
function handleMove(direction) {
  const moved = move(direction);
  
  if (moved) {
    addTile();
    setTimeout(() => {
      render();
      updateScore();
      
      if (checkWin()) {
        // –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ checkWin
      } else if (!canMove()) {
        finalScoreEl.textContent = score;
        gameOverOverlay.classList.add('active');
        saveBestScore();
      }
    }, 50);
  }
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—á—ë—Ç–∞
 */
function updateScore() {
  scoreEl.textContent = score;
}

/**
 * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ localStorage
 */
function saveBestScore() {
  if (score > best) {
    best = score;
    bestEl.textContent = best;
    localStorage.setItem('bestScore', best);
  }
}

/**
 * –ù–∞—á–∏–Ω–∞–µ—Ç –Ω–æ–≤—É—é –∏–≥—Ä—É, —Å–±—Ä–∞—Å—ã–≤–∞—è –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
 */
function newGame() {
  score = 0;
  hasWon = false;
  updateScore();
  gameOverOverlay.classList.remove('active');
  victoryOverlay.classList.remove('active');
  initGrid();
  addTile();
  addTile();
  render();
}

// ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ====================
/**
 * –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (—Å—Ç—Ä–µ–ª–∫–∏)
 */
document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowUp') handleMove('up');
  if (e.key === 'ArrowDown') handleMove('down');
  if (e.key === 'ArrowLeft') handleMove('left');
  if (e.key === 'ArrowRight') handleMove('right');
});

/**
 * –û–ë–†–ê–ë–û–¢–ö–ê –°–í–ê–ô–ü–û–í: –ì–õ–û–ë–ê–õ–¨–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö
 * –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ - –≤–µ—à–∞–µ–º –Ω–∞ document, –∞ –Ω–µ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç
 */
let touchStartX = 0;
let touchStartY = 0;
let isSwipeInProgress = false; // –§–ª–∞–≥, —á—Ç–æ–±—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ –∫–∞—Å–∞–Ω–∏—è

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–∞—Å–∞–Ω–∏—è, –Ω–∞—á–∞–≤—à–∏–µ—Å—è –Ω–∞ board-container
BOARD_CONTAINER.addEventListener('touchstart', (e) => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞—Å–∞–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å –∏–º–µ–Ω–Ω–æ –Ω–∞ –∏–≥—Ä–æ–≤–æ–º –ø–æ–ª–µ
  if (e.target.closest('.board') || e.target.closest('.board-container')) {
    isSwipeInProgress = true;
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞—Å–∞–Ω–∏–µ –Ω–∞ –∏–≥—Ä–µ
    e.preventDefault();
  }
}, { passive: false });

// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–Ω–µ—Ü –∫–∞—Å–∞–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ
document.addEventListener('touchend', (e) => {
  if (!isSwipeInProgress) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —Å–≤–∞–π–ø –Ω–µ –Ω–∞ –∏–≥—Ä–µ
  
  const touchEndX = e.changedTouches[0].clientX;
  const touchEndY = e.changedTouches[0].clientY;
  
  const dx = touchEndX - touchStartX;
  const dy = touchEndY - touchStartY;
  const absDx = Math.abs(dx);
  const absDy = Math.abs(dy);
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
  isSwipeInProgress = false;
  
  // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–æ–µ
  if (absDx > 30 || absDy > 30) {
    if (absDx > absDy) {
      // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø
      if (dx > 0) handleMove('right');
      else handleMove('left');
    } else {
      // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø
      if (dy > 0) handleMove('down');
      else handleMove('up');
    }
  }
}, { passive: true });

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –ø–∞–ª—å—Ü–µ–º
document.addEventListener('touchmove', (e) => {
  if (isSwipeInProgress) {
    e.preventDefault();
  }
}, { passive: false });

/**
 * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–º–µ–Ω—ã —Ç–µ–º—ã
 */
themeSelect.addEventListener('change', (e) => {
  const theme = e.target.value;
  document.body.className = theme === 'beige' ? '' : `theme-${theme}`;
  localStorage.setItem('theme', theme);
});

/**
 * –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π —Ç–µ–º—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
 */
const savedTheme = localStorage.getItem('theme') || 'beige';
if (savedTheme !== 'beige') {
  document.body.className = `theme-${savedTheme}`;
  themeSelect.value = savedTheme;
}

// ==================== –ü–†–ò–í–Ø–ó–ö–ê –ö–ù–û–ü–û–ö ====================
newGameBtn.addEventListener('click', newGame);
shuffleBtn.addEventListener('click', shuffleWithAnimation);
document.getElementById('restart').addEventListener('click', newGame);
document.getElementById('continue').addEventListener('click', () => {
  victoryOverlay.classList.remove('active');
});

// ==================== –ó–ê–ü–£–°–ö –ò–ì–†–´ ====================
// –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é —Å–µ—Ç–∫—É –∏ –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
initGrid();
newGame();
</script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2048 ‚Äî Classic & Chaos (Gradient Edition)</title>
<style>
:root{ 
  --accent:#6fb7e6; 
  --panel:#ffffff; 
  --text:#12343d;
  --board-bg: linear-gradient(180deg,#eef9ff,#f7fbff);
  --cell-bg: linear-gradient(180deg,#f4fbff,#eef7fb);
  --title-gradient: linear-gradient(45deg,#0e3b48 0%,#1a4a5c 25%,#2c5f6b 50%,#4a8b9a 75%,#6fb7e6 100%);
  --title-glow: rgba(111,183,230,0.5);
}

/* Ocean Theme Variables */
body.theme-ocean {
  --accent: #00bcd4;
  --panel: #e0f7fa;
  --text: #006064;
  --board-bg: linear-gradient(180deg,#b2ebf2,#80deea);
  --cell-bg: linear-gradient(180deg,#e0f2f1,#b2dfdb);
  --title-gradient: linear-gradient(45deg,#006064 0%,#00838f 25%,#0097a7 50%,#00acc1 75%,#00bcd4 100%);
  --title-glow: rgba(0,188,212,0.7);
}

/* Forest Theme Variables */
body.theme-forest {
  --accent: #4caf50;
  --panel: #e8f5e8;
  --text: #1b5e20;
  --board-bg: linear-gradient(180deg,#c8e6c9,#a5d6a7);
  --cell-bg: linear-gradient(180deg,#e8f5e8,#c8e6c9);
  --title-gradient: linear-gradient(45deg,#1b5e20 0%,#2e7d32 25%,#388e3c 50%,#43a047 75%,#4caf50 100%);
  --title-glow: rgba(76,175,80,0.7);
}

/* Space Theme Variables */
body.theme-space {
  --accent: #9c27b0;
  --panel: #1a1a2e;
  --text: #e1bee7;
  --board-bg: linear-gradient(180deg,#2d1b69,#1a1a2e);
  --cell-bg: linear-gradient(180deg,#3f2a7a,#2d1b69);
  --title-gradient: linear-gradient(45deg,#4a148c 0%,#6a1b9a 25%,#7b1fa2 50%,#8e24aa 75%,#9c27b0 100%);
  --title-glow: rgba(156,39,176,0.8);
}

/* Bubble Gum Theme Variables */
body.theme-bubblegum {
  --accent: #ff79b0;
  --panel: #fff0f6;
  --text: #6b0f3b;
  --board-bg: linear-gradient(180deg,#ffe0ef,#ffd1e8);
  --cell-bg: linear-gradient(180deg,#ffeaf3,#ffd6ea);
  --title-gradient: linear-gradient(45deg,#ff93c9 0%,#ff79b0 25%,#ff5fa1 50%,#ff8ac6 75%,#ffc1e3 100%);
  --title-glow: rgba(255,121,176,0.6);
}

*{box-sizing:border-box;margin:0;padding:0} html,body{height:100%}
body{
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  background: linear-gradient(135deg, #dceffb 0%, #f7d7ff 60%);
  display:flex;align-items:flex-start;justify-content:center;padding:20px;color:var(--text);
  transition: all 0.5s ease;
}

/* Ocean Theme Body */
body.theme-ocean {
  background: linear-gradient(135deg, #b3e5fc 0%, #81d4fa 50%, #4fc3f7 100%);
}
body.theme-ocean .board-shell::after{
  content: '';
  position:absolute; inset:0; pointer-events:none; z-index:1;
  background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="800" height="800" viewBox="0 0 800 800"><g fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2"><path d="M100 200c40 20 60 40 80 60s20 40 0 60-60 20-80 0-40-40 0-60z"/><path d="M400 500c30 15 45 30 60 45 15 15 15 30 0 45s-45 15-60 0-30-30 0-45z"/></g></svg>') repeat; 
  animation: oceanFish 18s linear infinite;
  opacity: 0.5;
}
@keyframes oceanFish{ from{ background-position: 0 0; } to{ background-position: 800px 0; } }

/* Forest Theme Body */
body.theme-forest {
  background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 50%, #81c784 100%);
}

/* Space Theme Body */
body.theme-space {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f1419 100%);
}

/* Bubble Gum Theme Body */
body.theme-bubblegum {
  background: linear-gradient(135deg, #ffd1e8 0%, #ff8ac6 50%, #ff79b0 100%);
}

.app{ 
  width:min(560px,96vw); 
  background:var(--panel); 
  border-radius:16px; 
  padding:20px; 
  box-shadow:0 18px 50px rgba(17,24,39,0.12); 
  position:relative; 
  border:3px solid #2d3748; 
  box-shadow:0 18px 50px rgba(17,24,39,0.12), 0 0 20px rgba(45,55,72,0.4); 
  animation:borderGlow 3s ease-in-out infinite;
  transition: all 0.5s ease;
}

/* Ocean Theme App */
body.theme-ocean .app {
  background: rgba(224,247,250,0.95);
  border-color: #00838f;
  box-shadow: 0 18px 50px rgba(0,131,143,0.2), 0 0 30px rgba(0,188,212,0.4);
}

/* Space Theme App */
body.theme-space .app {
  background: rgba(26,26,46,0.95);
  border-color: #9c27b0;
  color: #e1bee7;
}

/* Bubble Gum Theme App */
body.theme-bubblegum .app { 
  background: rgba(255,240,246,0.95); 
  border-color:#ff79b0; 
  box-shadow: 0 18px 50px rgba(255,121,176,0.2), 0 0 30px rgba(255,138,198,0.35); 
}

.header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
.title{
  font-size:42px;
  font-weight:900;
  background: var(--title-gradient);
  background-size:300% 300%;
  animation:gradientShift 4s ease infinite, titleFloat 6s ease-in-out infinite;
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  filter: drop-shadow(0 8px 16px rgba(14,59,72,0.25));
  transform:perspective(400px) rotateX(12deg) rotateY(-2deg);
  letter-spacing:4px;
  margin:0;
  position:relative;
  transition: all 0.5s ease;
}

.title::after{ content:none; }

/* Ocean Theme Title */
body.theme-ocean .title {
  text-shadow:
    0 6px 0 rgba(0,96,100,0.8),
    0 12px 0 rgba(0,96,100,0.6),
    0 18px 0 rgba(0,96,100,0.4),
    0 24px 0 rgba(0,96,100,0.2),
    0 30px 15px rgba(0,0,0,0.3),
    0 0 30px var(--title-glow);
  filter:drop-shadow(0 8px 16px rgba(0,96,100,0.3));
}

/* Space Theme Title */
body.theme-space .title {
  text-shadow:
    0 6px 0 rgba(74,20,140,0.8),
    0 12px 0 rgba(74,20,140,0.6),
    0 18px 0 rgba(74,20,140,0.4),
    0 24px 0 rgba(74,20,140,0.2),
    0 30px 15px rgba(0,0,0,0.5),
    0 0 30px var(--title-glow);
  filter:drop-shadow(0 8px 16px rgba(74,20,140,0.3));
}

/* Bubble Gum Theme Title */
body.theme-bubblegum .title {
  text-shadow:
    0 6px 0 rgba(255,121,176,0.8),
    0 12px 0 rgba(255,121,176,0.6),
    0 18px 0 rgba(255,121,176,0.4),
    0 24px 0 rgba(255,121,176,0.2),
    0 30px 15px rgba(255,121,176,0.3),
    0 0 30px var(--title-glow);
  filter:drop-shadow(0 8px 16px rgba(255,121,176,0.3));
}

.title::before{
  content:"2048";
  position:absolute;
  top:0;
  left:0;
  background:linear-gradient(45deg,#FFD700,#FFA500,#FF6B6B);
  background-size:200% 200%;
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  animation:titleGlow 3s ease-in-out infinite;
  opacity:0.7;
  z-index:-1;
  filter:blur(2px);
}

/* Ocean Theme Title Glow */
body.theme-ocean .title::before {
  background:linear-gradient(45deg,#00bcd4,#4dd0e1,#26c6da);
}

/* Space Theme Title Glow */
body.theme-space .title::before {
  background:linear-gradient(45deg,#9c27b0,#ba68c8,#ce93d8);
}

/* Bubble Gum Theme Title Glow */
body.theme-bubblegum .title::before {
  background:linear-gradient(45deg,#ff79b0,#ffc1e3,#ff93c9);
}

@keyframes titleFloat{
  0%,100%{transform:perspective(400px) rotateX(12deg) rotateY(-2deg) translateY(0px)}
  50%{transform:perspective(400px) rotateX(12deg) rotateY(-2deg) translateY(-3px)}
}
@keyframes titleGlow{
  0%,100%{opacity:0.3;transform:scale(1.02)}
  50%{opacity:0.8;transform:scale(1.05)}
}
.subtitle{font-size:13px;color:#45636c;margin-top:8px;font-weight:800;transition: color 0.5s ease; text-shadow: 0 1px 0 rgba(0,0,0,0.05), 0 2px 4px rgba(0,0,0,0.08);}

/* Ocean Theme Subtitle */
body.theme-ocean .subtitle {
  color: #00695c;
}

/* Space Theme Subtitle */
body.theme-space .subtitle {
  color: #ce93d8;
}

/* Bubble Gum Theme Subtitle */
body.theme-bubblegum .subtitle{ 
  color:#a83b73; 
}

.stats{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.score-pill{
  background:linear-gradient(180deg,var(--accent),#58aee8);
  color:#fff;
  padding:8px 12px;
  border-radius:10px;
  font-weight:700;
  font-size:13px;
  transition: all 0.5s ease;
}

/* Ocean Theme Score Pills */
body.theme-ocean .score-pill {
  background:linear-gradient(180deg,var(--accent),#26c6da);
}

/* Space Theme Score Pills */
body.theme-space .score-pill {
  background:linear-gradient(180deg,var(--accent),#ba68c8);
}

/* Bubble Gum Theme Score Pills */
body.theme-bubblegum .score-pill {
  background:linear-gradient(180deg,var(--accent),#ff8ac6);
}

.controls{display:flex;gap:8px;margin:14px 0;flex-wrap:wrap}
.mode-btn, .btn{
  background:#fff;
  border:1px solid rgba(0,0,0,0.08);
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
  transition: all 0.5s ease;
}

/* Ocean Theme Buttons */
body.theme-ocean .mode-btn, 
body.theme-ocean .btn {
  background: rgba(224,247,250,0.8);
  color: var(--text);
  border-color: rgba(0,131,143,0.2);
}

/* Space Theme Buttons */
body.theme-space .mode-btn, 
body.theme-space .btn {
  background: rgba(26,26,46,0.8);
  color: #e1bee7;
  border-color: rgba(156,39,176,0.3);
}

/* Bubble Gum Theme Buttons */
body.theme-bubblegum .mode-btn, 
body.theme-bubblegum .btn {
  background: rgba(255,240,246,0.8);
  color: var(--text);
  border-color: rgba(255,121,176,0.2);
}

.mode-btn.active{
  background:var(--accent);
  color:#fff;
  border:none;
  box-shadow:0 8px 18px rgba(0,0,0,0.08);
}
.btn.primary{
  background:var(--accent);
  color:#fff;
  border:none;
}

.board-wrap{ display:flex; align-items:flex-start; gap:12px; position:relative; }
.board-shell{
  background: var(--board-bg);
  padding:14px;
  border-radius:14px;
  box-shadow: inset 0 6px 14px rgba(255,255,255,0.6), 0 12px 30px rgba(17,24,39,0.06); 
  margin-top:6px;
  position:relative;
  transition: all 0.5s ease;
}

/* Ocean Theme Board Shell */
body.theme-ocean .board-shell {
  box-shadow: inset 0 6px 14px rgba(0,188,212,0.3), 0 12px 30px rgba(0,131,143,0.15);
}

/* Space Theme Board Shell */
body.theme-space .board-shell {
  box-shadow: inset 0 6px 14px rgba(156,39,176,0.3), 0 12px 30px rgba(74,20,140,0.2);
}

/* Bubble Gum Theme Board Shell */
body.theme-bubblegum .board-shell {
  box-shadow: inset 0 6px 14px rgba(255,121,176,0.3), 0 12px 30px rgba(255,138,198,0.15);
}

.board{width:460px;height:460px;display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(4,1fr);gap:16px;padding:14px;border-radius:12px;position:relative;overflow:hidden;max-width:100%;max-height:100%;touch-action:none}
.cell{
  background: var(--cell-bg);
  border-radius:12px;
  box-shadow: inset 0 4px 10px rgba(255,255,255,0.6), 0 6px 12px rgba(0,0,0,0.03);
  transition: all 0.5s ease;
}

/* Ocean Theme Cells */
body.theme-ocean .cell {
  box-shadow: inset 0 4px 10px rgba(0,188,212,0.2), 0 6px 12px rgba(0,131,143,0.1);
}

/* Space Theme Cells */
body.theme-space .cell {
  box-shadow: inset 0 4px 10px rgba(156,39,176,0.2), 0 6px 12px rgba(74,20,140,0.15);
}

/* Bubble Gum Theme Cells */
body.theme-bubblegum .cell{ 
  box-shadow: inset 0 4px 10px rgba(255,121,176,0.2), 0 6px 12px rgba(255,138,198,0.15); 
}

.tile{ 
  position:absolute;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:10px;
  font-weight:900;
  color:#12343d;
  box-shadow: 0 12px 30px rgba(15,23,42,0.12), inset 0 1px 0 rgba(255,255,255,0.4); 
  transition: transform 400ms cubic-bezier(0.25, 0.46, 0.45, 0.94), width 350ms, height 200ms, background 0.5s ease; 
  user-select:none; 
  will-change:transform; 
  font-size:20px; 
}

/* Ocean Theme Tiles */
body.theme-ocean .tile.v2{background:linear-gradient(180deg,#e0f7ff,#b3e5fc);color:#01579b}
body.theme-ocean .tile.v4{background:linear-gradient(180deg,#b3e5fc,#81d4fa);color:#01579b}
body.theme-ocean .tile.v8{background:linear-gradient(180deg,#81d4fa,#4fc3f7);color:#fff}
body.theme-ocean .tile.v16{background:linear-gradient(180deg,#4fc3f7,#29b6f6);color:#fff}
body.theme-ocean .tile.v32{background:linear-gradient(180deg,#29b6f6,#039be5);color:#fff}
body.theme-ocean .tile.v64{background:linear-gradient(180deg,#039be5,#0288d1);color:#fff}
body.theme-ocean .tile.v128{background:linear-gradient(180deg,#0288d1,#0277bd);color:#fff;font-size:18px}
body.theme-ocean .tile.v256{background:linear-gradient(180deg,#0277bd,#01579b);color:#fff;font-size:18px}
body.theme-ocean .tile.v512{background:linear-gradient(180deg,#01579b,#003c6c);color:#fff;font-size:18px}
body.theme-ocean .tile.v1024{background:linear-gradient(180deg,#006db3,#004b8d);color:#fff;font-size:18px}
body.theme-ocean .tile.v2048{background:linear-gradient(180deg,#0288d1,#006db3);color:#fff;font-size:18px;box-shadow:0 12px 34px rgba(2,136,209,0.35)}

/* Forest Theme Tiles */
body.theme-forest .tile.v2{background:linear-gradient(180deg,#e8f5e8,#c8e6c9);color:#1b5e20}
body.theme-forest .tile.v4{background:linear-gradient(180deg,#c8e6c9,#a5d6a7);color:#1b5e20}
body.theme-forest .tile.v8{background:linear-gradient(180deg,#a5d6a7,#81c784);color:#fff}
body.theme-forest .tile.v16{background:linear-gradient(180deg,#81c784,#66bb6a);color:#fff}
body.theme-forest .tile.v32{background:linear-gradient(180deg,#66bb6a,#4caf50);color:#fff}
body.theme-forest .tile.v64{background:linear-gradient(180deg,#4caf50,#43a047);color:#fff}
body.theme-forest .tile.v128{background:linear-gradient(180deg,#43a047,#388e3c);color:#fff;font-size:18px}
body.theme-forest .tile.v256{background:linear-gradient(180deg,#388e3c,#2e7d32);color:#fff;font-size:18px}
body.theme-forest .tile.v512{background:linear-gradient(180deg,#2e7d32,#27691c);color:#fff;font-size:18px}
body.theme-forest .tile.v1024{background:linear-gradient(180deg,#27691c,#1b5e20);color:#fff;font-size:18px}
body.theme-forest .tile.v2048{background:linear-gradient(180deg,#4caf50,#2e7d32);color:#fff;font-size:18px;box-shadow:0 12px 34px rgba(76,175,80,0.4)}

/* Space Theme Tiles */
body.theme-space .tile.v2{background:linear-gradient(180deg,#3f2a7a,#2d1b69);color:#e1bee7}
body.theme-space .tile.v4{background:linear-gradient(180deg,#512da8,#3f2a7a);color:#e1bee7}
body.theme-space .tile.v8{background:linear-gradient(180deg,#673ab7,#512da8);color:#fff}
body.theme-space .tile.v16{background:linear-gradient(180deg,#7b1fa2,#673ab7);color:#fff}
body.theme-space .tile.v32{background:linear-gradient(180deg,#8e24aa,#7b1fa2);color:#fff}
body.theme-space .tile.v64{background:linear-gradient(180deg,#9c27b0,#8e24aa);color:#fff}
body.theme-space .tile.v128{background:linear-gradient(180deg,#ab47bc,#9c27b0);color:#fff;font-size:18px}
body.theme-space .tile.v256{background:linear-gradient(180deg,#ba68c8,#ab47bc);color:#fff;font-size:18px}
body.theme-space .tile.v512{background:linear-gradient(180deg,#ce93d8,#ba68c8);color:#fff;font-size:18px}
body.theme-space .tile.v1024{background:linear-gradient(180deg,#e1bee7,#ce93d8);color:#4a148c;font-size:18px}
body.theme-space .tile.v2048{background:linear-gradient(180deg,#9c27b0,#6a1b9a);color:#fff;font-size:18px;box-shadow:0 12px 34px rgba(156,39,176,0.4)}

/* Bubble Gum Theme Tiles */
body.theme-bubblegum .tile.v2{ background: linear-gradient(180deg,#ffd6ea,#ffc1e3); color:#6b0f3b }
body.theme-bubblegum .tile.v4{ background: linear-gradient(180deg,#ffc1e3,#ffaddb); color:#6b0f3b }
body.theme-bubblegum .tile.v8{ background: linear-gradient(180deg,#ffaddb,#ff93c9); color:#fff }
body.theme-bubblegum .tile.v16{ background: linear-gradient(180deg,#ff93c9,#ff79b0); color:#fff }
body.theme-bubblegum .tile.v32{ background: linear-gradient(180deg,#ff79b0,#ff5fa1); color:#fff }
body.theme-bubblegum .tile.v64{ background: linear-gradient(180deg,#ff5fa1,#ff4f95); color:#fff }
body.theme-bubblegum .tile.v128{ background: linear-gradient(180deg,#ff4f95,#e83e86); color:#fff; font-size:18px }
body.theme-bubblegum .tile.v256{ background: linear-gradient(180deg,#e83e86,#c72d73); color:#fff; font-size:18px }
body.theme-bubblegum .tile.v512{ background: linear-gradient(180deg,#c72d73,#a61c60); color:#fff; font-size:18px }
body.theme-bubblegum .tile.v1024{ background: linear-gradient(180deg,#a61c60,#8a124f); color:#fff; font-size:18px }
body.theme-bubblegum .tile.v2048{ background: linear-gradient(180deg,#ff79b0,#ff4f95); color:#fff; font-size:18px; box-shadow:0 12px 34px rgba(255,121,176,0.4) }

/* Default Theme Tiles */
.tile.v2{background:linear-gradient(180deg,#e8f7fb,#dff3fb);color:#0e3b48}
.tile.v4{background:linear-gradient(180deg,#dff3f9,#d0ecf9);color:#0e3b48}
.tile.v8{background:linear-gradient(180deg,#ffd6ad,#ffbf7a);color:#fff}
.tile.v16{background:linear-gradient(180deg,#ffb07b,#ff8d49);color:#fff}
.tile.v32{background:linear-gradient(180deg,#ffa07b,#ff7a49);color:#fff}
.tile.v64{background:linear-gradient(180deg,#e8755d,#d94a2b);color:#fff}
.tile.v128{background:#b07ad9;color:#fff;font-size:18px}
.tile.v256{background:#8a6bd1;color:#fff;font-size:18px}
.tile.v512{background:#5b4a9e;color:#fff;font-size:18px}
.tile.v1024{background:#3e2f7b;color:#fff;font-size:18px}
.tile.v2048{background:#2b1f59;color:#fff;font-size:18px;box-shadow:0 12px 34px rgba(0,0,0,0.25)}

/* Chaos Mode Special Tiles */
.tile.chaos-bomb{background:linear-gradient(135deg,#ff4757,#ff3742);color:#fff;font-size:24px}
.tile.chaos-bomb::before{content:"üí£";font-size:20px}
.tile.chaos-multiplier{background:linear-gradient(135deg,#ffa502,#ff9500);color:#fff;font-size:24px}
.tile.chaos-multiplier::before{content:"√ó2";font-size:16px;font-weight:900}
.tile.chaos-freeze{background:linear-gradient(135deg,#70a1ff,#5352ed);color:#fff;font-size:24px}
.tile.chaos-freeze::before{content:"‚ùÑÔ∏è";font-size:20px}
.tile.chaos-wildcard{background:linear-gradient(135deg,#7bed9f,#2ed573);color:#fff;font-size:24px}
.tile.chaos-wildcard::before{content:"‚òÖ";font-size:20px}
.tile.chaos-shuffle{background:linear-gradient(135deg,#a4b0be,#747d8c);color:#fff;font-size:24px}
.tile.chaos-shuffle::before{content:"üîÄ";font-size:16px}

.tile.frozen{
  filter: brightness(0.7) saturate(0.5);
  border: 2px solid #70a1ff;
  animation: frozenPulse 1s ease-in-out infinite;
}

@keyframes frozenPulse{
  0%,100%{box-shadow: 0 0 10px rgba(112,161,255,0.5)}
  50%{box-shadow: 0 0 20px rgba(112,161,255,0.8)}
}

@keyframes vibrate {0%{transform:translate(var(--tile-x),var(--tile-y)) rotate(0deg)}25%{transform:translate(calc(var(--tile-x) + 2px),var(--tile-y)) rotate(1deg)}50%{transform:translate(var(--tile-x),calc(var(--tile-y) + 2px)) rotate(-1deg)}75%{transform:translate(calc(var(--tile-x) - 2px),var(--tile-y)) rotate(1deg)}100%{transform:translate(var(--tile-x),var(--tile-y)) rotate(0deg)}}
.tile.v1024{animation:vibrate .25s infinite linear}
@keyframes magnet {0%,100%{transform:translate(var(--tile-x),var(--tile-y)) scale(1)}50%{transform:translate(var(--tile-x),var(--tile-y)) scale(1.12)}}
.tile.v2048{animation:magnet 1s infinite ease-in-out}
@keyframes legendaryPulse{0%{transform:translate(var(--tile-x),var(--tile-y)) scale(1);filter:drop-shadow(0 0 6px rgba(255,150,0,0.2))}50%{transform:translate(var(--tile-x),var(--tile-y)) scale(1.14);filter:drop-shadow(0 0 20px rgba(126,255,199,0.45))}100%{transform:translate(var(--tile-x),var(--tile-y)) scale(1);filter:drop-shadow(0 0 6px rgba(255,150,0,0.2))}}
.tile.legendary{background:linear-gradient(135deg,#ff5f6d 0%,#ffc371 50%,#7effc7 100%);color:#111;box-shadow:0 12px 40px rgba(255,150,0,0.35),0 0 40px rgba(126,255,199,0.12) inset;border:2px solid rgba(255,215,0,0.6);animation:legendaryPulse 1.6s ease-in-out infinite;font-weight:900}
.tile.new{ animation: pop 420ms cubic-bezier(.22,.9,.12,1); transform-origin:center; }
@keyframes pop{0%{transform:translate(var(--tile-x),var(--tile-y)) scale(.2) rotate(-6deg);opacity:0}60%{transform:translate(var(--tile-x),var(--tile-y)) scale(1.08) rotate(2deg);opacity:1}100%{transform:translate(var(--tile-x),var(--tile-y)) scale(1) rotate(0deg);opacity:1}}
@keyframes slideInUp{0%{transform:translateY(60px);opacity:0}100%{transform:translateY(0);opacity:1}}
@keyframes glowPulse{0%,100%{box-shadow:0 8px 32px rgba(0,0,0,0.3), 0 0 20px currentColor}50%{box-shadow:0 8px 32px rgba(0,0,0,0.3), 0 0 30px currentColor}}
@keyframes bounceIn{0%{transform:scale(0.3);opacity:0}50%{transform:scale(1.05)}70%{transform:scale(0.9)}100%{transform:scale(1);opacity:1}}
@keyframes float{0%,100%{transform:translateY(0px)}50%{transform:translateY(-10px)}}
@keyframes wiggle{0%,100%{transform:rotate(-3deg)}50%{transform:rotate(3deg)}}
@keyframes borderGlow{0%,100%{box-shadow:0 18px 50px rgba(17,24,39,0.12), 0 0 20px rgba(45,55,72,0.4)}50%{box-shadow:0 18px 50px rgba(17,24,39,0.12), 0 0 30px rgba(45,55,72,0.6)}}
@keyframes explosion{0%{transform:scale(1) rotate(0deg);filter:brightness(1)}50%{transform:scale(1.5) rotate(180deg);filter:brightness(2) saturate(2)}100%{transform:scale(3) rotate(360deg);filter:brightness(3) saturate(3);opacity:0}}
@keyframes victoryPulse{0%{transform:scale(1);filter:drop-shadow(0 0 20px rgba(255,215,0,0.8))}50%{transform:scale(1.1);filter:drop-shadow(0 0 40px rgba(255,215,0,1))}100%{transform:scale(1);filter:drop-shadow(0 0 20px rgba(255,215,0,0.8))}}
@keyframes fireworks{0%{transform:translateY(100vh) scale(0);opacity:0}50%{opacity:1}100%{transform:translateY(-100vh) scale(1.5);opacity:0}}
@keyframes starBurst{0%{transform:scale(0) rotate(0deg);opacity:1}50%{transform:scale(1.2) rotate(180deg);opacity:0.8}100%{transform:scale(2) rotate(360deg);opacity:0}}
@keyframes victoryShake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-10px) rotate(-1deg)}20%,40%,60%,80%{transform:translateX(10px) rotate(1deg)}}
.victory-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:2000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.5s ease}
.victory-content{background:linear-gradient(145deg,#1a1a2e 0%,#16213e 50%,#0f1419 100%);border:4px solid #FFD700;border-radius:24px;padding:40px;max-width:500px;width:90%;text-align:center;color:#fff;box-shadow:0 20px 60px rgba(0,0,0,0.5),0 0 40px rgba(255,215,0,0.5);animation:bounceIn 0.8s ease, victoryPulse 2s ease-in-out infinite 1s}
.victory-title{font-size:48px;font-weight:900;background:linear-gradient(45deg,#FFD700,#FFA500,#FF6B6B,#4ECDC4);background-size:400% 400%;animation:gradientShift 2s ease infinite;text-shadow:0 6px 0 #FFD700,0 12px 0 rgba(255,215,0,0.8),0 18px 0 rgba(255,215,0,0.6),0 24px 0 rgba(255,215,0,0.4),0 30px 0 rgba(255,215,0,0.2),0 36px 20px rgba(0,0,0,0.3);transform:perspective(400px) rotateX(15deg);color:#fff;letter-spacing:4px;margin:20px 0;animation:gradientShift 2s ease infinite, victoryShake 0.5s ease-in-out 2s}
.explosion-particle{position:absolute;width:8px;height:8px;background:radial-gradient(circle,#FFD700,#FFA500);border-radius:50%;pointer-events:none;animation:starBurst 1s ease-out forwards}
.firework{position:absolute;width:4px;height:4px;background:radial-gradient(circle,#FFD700,#FF6B6B,#4ECDC4);border-radius:50%;pointer-events:none;animation:fireworks 3s ease-out forwards}
.title-3d{font-size:56px;font-weight:900;background:linear-gradient(45deg,#FFD700,#FFA500,#FF6B6B,#4ECDC4);background-size:400% 400%;animation:gradientShift 3s ease infinite;text-shadow:0 6px 0 #FFD700,0 12px 0 rgba(255,215,0,0.8),0 18px 0 rgba(255,215,0,0.6),0 24px 0 rgba(255,215,0,0.4),0 30px 0 rgba(255,215,0,0.2),0 36px 15px rgba(0,0,0,0.3);transform:perspective(500px) rotateX(15deg);color:#fff;letter-spacing:3px;margin:15px 0}
@keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.tutorial-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:1000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.5s ease;padding:20px;box-sizing:border-box}
@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}
.tutorial-content{background:linear-gradient(145deg,#1a1a2e 0%,#16213e 50%,#0f1419 100%);border:3px solid #FFD700;border-radius:20px;padding:25px;max-width:480px;width:90%;text-align:center;color:#fff;box-shadow:0 20px 60px rgba(0,0,0,0.5),0 0 30px rgba(255,215,0,0.3);animation:bounceIn 0.8s ease;margin:auto;position:relative;max-height:90vh;overflow-y:auto}
.tutorial-character{font-size:80px;margin-bottom:15px;animation:float 2s ease-in-out infinite;filter:drop-shadow(0 0 20px rgba(255,215,0,0.5));transition:transform 0.3s ease}
.tutorial-character:hover{animation:wiggle 0.5s ease-in-out infinite}
.tutorial-step{background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;margin:15px 0;border-left:4px solid #FFD700}
.tutorial-btn{background:linear-gradient(135deg,#FFD700,#FFA500);color:#000;border:none;padding:12px 24px;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;margin:8px;transition:all 0.3s ease;box-shadow:0 6px 16px rgba(255,215,0,0.3)}
.tutorial-btn:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(255,215,0,0.5)}
.tutorial-btn.secondary{background:linear-gradient(135deg,#666,#555);color:#fff}
.tutorial-btn.secondary:hover{background:linear-gradient(135deg,#777,#666)}
.modal, .results-panel, #shop-panel{background:var(--panel);padding:14px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.14);position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:120;display:none;max-width:94vw}
.modal.active, .results-panel.active, #shop-panel.active{display:block}
#results-list{max-height:320px;overflow-y:auto;padding-left:12px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;}
.results-list-item{display:flex;align-items:center;gap:12px;padding:8px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfbf8);margin-bottom:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.results-list-item .rank{width:44px;text-align:center;font-weight:900}
.results-list-item.gold-card{background:linear-gradient(145deg,#fff8dc,#ffd700,#ffae00);border:3px solid #ffd700;color:#3b2b00;font-weight:900;box-shadow:0 0 20px rgba(255,215,0,0.95),0 0 40px rgba(255,165,0,0.75);position:relative;padding-left:40px}
.results-list-item.gold-card::before{content:"üëë";position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:22px}
.results-list-item.silver-card{background:linear-gradient(145deg,#f8f9fa,#c0c0c0,#a8a8a8);border:3px solid #c0c0c0;color:#2c3e50;font-weight:900;box-shadow:0 0 20px rgba(192,192,192,0.8),0 0 40px rgba(168,168,168,0.6);position:relative;padding-left:40px}
.results-list-item.silver-card::before{content:"ü•à";position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:22px}
.results-list-item.bronze-card{background:linear-gradient(145deg,#fdf5e6,#cd7f32,#b8860b);border:3px solid #cd7f32;color:#8b4513;font-weight:900;box-shadow:0 0 20px rgba(205,127,50,0.8),0 0 40px rgba(184,134,11,0.6);position:relative;padding-left:40px}
.results-list-item.bronze-card::before{content:"ü•â";position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:22px}
#bottom-nav{position:fixed;left:10px;right:10px;bottom:12px;height:76px;background:#fff;border-radius:14px;display:flex;gap:8px;align-items:center;justify-content:space-around;box-shadow:0 18px 40px rgba(2,6,23,0.12);z-index:200}
#bottom-nav .nav-btn{flex:1;border:none;background:none;padding:10px;border-radius:10px;font-weight:700;color:#666;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer}
#bottom-nav .nav-btn span{font-size:22px}
#bottom-nav .nav-btn.active{color:#1e90ff;text-shadow:0 0 10px rgba(30,144,255,0.4)}
.btn-danger{ background: linear-gradient(135deg,#f44336,#d32f2f); color:#fff; border:none; }
.btn-danger:hover{ filter: brightness(1.05); }
#shop-panel{left:50%;transform:translate(-50%,0);bottom:92px;top:auto;position:fixed;width:min(400px,90vw);max-height:70vh;overflow:hidden;display:none;background:linear-gradient(145deg,#1a1a2e 0%,#16213e 50%,#0f1419 100%);color:#fff;border:2px solid #4a5568;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.5),0 0 30px rgba(59,130,246,0.3)}
#shop-items{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:12px;overflow-y:auto;max-height:50vh}
#chaos-tips{
  position:sticky;
  top:10px;
  align-self:flex-start;
  width:220px;
  background:#fff;
  padding:10px;
  border-radius:10px;
  box-shadow:0 8px 24px rgba(0,0,0,0.15);
  display:none;
  z-index:10;
  font-size:12px;
  border:2px solid #2d3748;
  transform:none;
  transition: all 0.3s ease;
}
.chaos-aside{ margin-top:6px; }

/* Ocean Theme Chaos Tips */
body.theme-ocean #chaos-tips {
  background: rgba(224,247,250,0.95);
  border-color: #00838f;
  color: #004d40;
}

/* Space Theme Chaos Tips */
body.theme-space #chaos-tips {
  background: rgba(26,26,46,0.95);
  border-color: #9c27b0;
  color: #e1bee7;
}

/* Bubble Gum Theme Chaos Tips */
body.theme-bubblegum #chaos-tips {
  background: rgba(255,240,246,0.95);
  border-color: #ff79b0;
  color: #6b0f3b;
}

/* Bubble Gum Special Effects */
body.theme-bubblegum .board-shell::before {
  content: '';
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 1;
  background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="20" cy="30" r="8" fill="rgba(255,121,176,0.3)" opacity="0.6"><animate attributeName="cy" values="30;10;30" dur="3s" repeatCount="indefinite"/></circle><circle cx="80" cy="70" r="6" fill="rgba(255,193,227,0.4)" opacity="0.5"><animate attributeName="cy" values="70;50;70" dur="4s" repeatCount="indefinite"/></circle><circle cx="50" cy="20" r="4" fill="rgba(255,138,198,0.3)" opacity="0.7"><animate attributeName="cy" values="20;5;20" dur="2.5s" repeatCount="indefinite"/></circle></svg>') repeat;
  animation: bubbleFloat 15s linear infinite;
  opacity: 0.4;
}

@keyframes bubbleFloat {
  from { background-position: 0 0; }
  to { background-position: 100px 0; }
}

@media(max-width:520px){ 
  .app{padding:12px} 
  #bottom-nav{left:8px;right:8px;height:72px} 
  .tutorial-content{padding:20px;max-width:95vw;max-height:85vh} 
  .title-3d{font-size:40px;letter-spacing:2px;margin:10px 0} 
  .tutorial-character{font-size:60px;margin-bottom:10px} 
  .tutorial-btn{padding:10px 16px;font-size:14px;margin:6px} 
  .tutorial-step{padding:12px;margin:12px 0} 
  .title{
    font-size:32px;
    letter-spacing:3px;
    text-shadow:
      0 4px 0 rgba(14,59,72,0.8),
      0 8px 0 rgba(14,59,72,0.6),
      0 12px 0 rgba(14,59,72,0.4),
      0 16px 0 rgba(14,59,72,0.2),
      0 20px 12px rgba(0,0,0,0.3),
      0 0 20px rgba(111,183,230,0.4);
    transform:perspective(300px) rotateX(10deg) rotateY(-1deg);
  } 
  #shop-panel{width:95vw;max-height:80vh} 
  #shop-items{grid-template-columns:1fr;gap:8px;max-height:60vh} 
  /* Chaos tips go below the board on small screens */
  .board-wrap{ flex-direction:column; }
  #chaos-tips{
    position:relative;
    width:100%;
    margin-top:10px;
    right:auto;
    top:auto;
    transform:none;
    z-index:1;
  }
  #results-list{
    max-height:250px;
    overflow-y:scroll;
    -webkit-overflow-scrolling:touch;
    overscroll-behavior:contain;
  }
  /* Board scales to viewport safely */
  .board{width:100%;height:100vw;max-height:92vw;max-width:92vw;gap:10px;padding:12px;overflow:hidden}
  .board-shell{padding:10px}
}
.hidden{display:none}

/* === THEMED TILE ANIMATIONS === */
@keyframes oceanFloat {
  0%, 100% { transform: translate(var(--tile-x), var(--tile-y)) scale(1) rotate(0deg); }
  50% { transform: translate(calc(var(--tile-x) + 2px), calc(var(--tile-y) - 3px)) scale(1.05) rotate(1deg); }
}
@keyframes forestRustle {
  0%, 100% { transform: translate(var(--tile-x), var(--tile-y)) rotate(-1deg); }
  50% { transform: translate(calc(var(--tile-x) + 1px), calc(var(--tile-y) - 2px)) rotate(2deg); }
}
@keyframes spaceFloat {
  0%, 100% { transform: translate(var(--tile-x), var(--tile-y)) scale(1); filter: drop-shadow(0 0 8px rgba(156,39,176,0.3)); }
  50% { transform: translate(calc(var(--tile-x) + 1px), calc(var(--tile-y) - 4px)) scale(1.08); filter: drop-shadow(0 0 14px rgba(156,39,176,0.6)); }
}
@keyframes bubblegumBounce {
  0%, 100% { transform: translate(var(--tile-x), var(--tile-y)) scale(1) rotate(0deg); }
  50% { transform: translate(calc(var(--tile-x) + 2px), calc(var(--tile-y) - 5px)) scale(1.1) rotate(2deg); }
}

body.theme-ocean .tile { animation: oceanFloat 3s ease-in-out infinite; }
body.theme-forest .tile { animation: forestRustle 2.5s ease-in-out infinite; }
body.theme-space .tile { animation: spaceFloat 4s ease-in-out infinite; }
body.theme-bubblegum .tile { animation: bubblegumBounce 2.8s ease-in-out infinite; }

/* Disable subtle floating animations on small screens to avoid overflow jitter */
@media (max-width:520px){
  body.theme-ocean .tile,
  body.theme-forest .tile,
  body.theme-space .tile,
  body.theme-bubblegum .tile { animation: none; }
}

/* === Additional mobile tweaks === */
@media (max-width:400px){
  .title{ font-size:24px; }
  .score-pill{ font-size:11px; padding:6px 8px; }
  .mode-btn, .btn{ font-size:12px; padding:6px 10px; }
  .board{ gap:8px; padding:10px; max-width:94vw; max-height:94vw; }
  #bottom-nav{height:68px;}
}

.btn-danger{ background: linear-gradient(135deg,#f44336,#d32f2f); color:#fff; border:none; }
.btn-danger:hover{ filter: brightness(1.05); }

/* Chupa Chups overlay */
.board-shell .candy-wrap{ position:absolute; inset:10px; pointer-events:none; z-index:1; display:flex; align-items:flex-end; justify-content:flex-end; }
.board-shell .candy{
  position:relative; height:100%; aspect-ratio: 9/16; object-fit:contain; filter: saturate(1.05) contrast(1.05) drop-shadow(0 10px 20px rgba(0,0,0,0.15));
  image-rendering:auto;
}
.board-shell .candy--right{ align-self:flex-end; max-width:40%; }
.board-shell .candy--left{ align-self:flex-start; max-width:30%; transform: rotate(-8deg); }

@media(max-width:520px){
  .board-shell .candy--right{ max-width:48%; }
  .board-shell .candy--left{ max-width:36%; }
}

</style>
</head>
<body>
<div id="tutorial-modal" class="tutorial-modal" style="z-index:300">
  <div class="tutorial-content">
    <div class="tutorial-character">üßô‚Äç‚ôÇÔ∏è</div>
    <div class="title-3d">2048</div>
    <h2 style="margin:15px 0;color:#FFD700;font-size:22px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Classic & Chaos!</h2>
    
    <div class="tutorial-step">
      <h3 style="color:#4ECDC4;margin-bottom:8px;font-size:16px;">üéØ –¶–µ–ª—å –∏–≥—Ä—ã</h3>
      <p style="font-size:14px;margin:0;">–û–±—ä–µ–¥–∏–Ω—è–π—Ç–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —á–∏—Å–ª–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å 2048!</p>
    </div>
    
    <div class="tutorial-step">
      <h3 style="color:#FF6B6B;margin-bottom:8px;font-size:16px;">üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
      <p style="font-size:14px;margin:0;">–°—Ç—Ä–µ–ª–∫–∏ ‚Üê‚Üë‚Üí‚Üì –∏–ª–∏ —Å–≤–∞–π–ø—ã</p>
    </div>
    
    <div class="tutorial-step">
      <h3 style="color:#4ECDC4;margin-bottom:8px;font-size:16px;">‚ö° –†–µ–∂–∏–º—ã</h3>
      <p style="font-size:14px;margin:0;"><strong>–ö–ª–∞—Å—Å–∏–∫–∞:</strong> –û–±—ã—á–Ω–∞—è –∏–≥—Ä–∞<br>
      <strong>–•–∞–æ—Å:</strong> –ú–∞–≥–∏—á–µ—Å–∫–∏–µ –ø–ª–∏—Ç–∫–∏!</p>
    </div>
    
    <div style="margin-top:20px;">
      <button id="tutorial-start" class="tutorial-btn">üöÄ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É!</button>
      <button id="tutorial-shop" class="tutorial-btn" style="background:linear-gradient(135deg,#4ECDC4,#44A08D);color:#fff;">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</button>
    </div>
    
    <div style="margin-top:15px;">
      <button id="tutorial-skip" class="tutorial-btn secondary">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    </div>
    
    <div style="margin-top:15px;font-size:12px;color:#aaa;">
      üí° –í —Ä–µ–∂–∏–º–µ –•–∞–æ—Å –µ—Å—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –ø–ª–∏—Ç–æ–∫
    </div>
  </div>
</div>
<div class="app" id="game-app" role="application" aria-label="2048 game" style="display:none;">
  <div class="header">
    <div>
      <div class="title">2048</div>
      <div class="subtitle">Classic & Chaos ‚Äî Gradient Edition</div>
    </div>
    <div class="stats">
      <div class="score-pill">–°—á—ë—Ç: <span id="score">0</span></div>
      <div class="score-pill">–õ—É—á—à–∏–π: <span id="best-score">0</span></div>
      <div class="score-pill">–•–æ–¥—ã: <span id="moves">0</span></div>
          </div>
  </div>
  <div class="controls" role="toolbar">
    <button id="mode-classic" class="mode-btn active">–ö–ª–∞—Å—Å–∏–∫–∞</button>
    <button id="mode-chaos" class="mode-btn">–•–∞–æ—Å</button>
    <button id="new-game-btn" class="btn primary">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
  </div>
  <div class="board-wrap">
    <div class="board-shell">
      <div id="game-board" class="board" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ" tabindex="0"></div>
      <div class="candy-wrap">
        <img class="candy candy--right" id="bubblegum-candy-1" alt="candy" style="display:none;" />
        <img class="candy candy--left" id="bubblegum-candy-2" alt="candy" style="display:none;" />
      </div>
    </div>
    <aside id="chaos-tips" aria-hidden="true" class="chaos-aside">
      <h4 style="margin:0 0 8px 0;color:#2d3748;font-size:14px;font-weight:700;">üîÆ –ü–æ–¥—Å–∫–∞–∑–∫–∏ –•–∞–æ—Å–∞</h4>
      <ul style="margin:0;padding-left:16px;font-size:11px;line-height:1.4;">
        <li>üí£ <b>–ë–æ–º–±–∞</b> ‚Äî —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç —Å–æ—Å–µ–¥–Ω–∏–µ –ø–ª–∏—Ç–∫–∏</li>
        <li>√ó <b>–ú–Ω–æ–∂–∏—Ç–µ–ª—å</b> ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–æ—Å–µ–¥–Ω–∏–π –∫—É–±</li>
        <li>‚ùÑ <b>–ó–∞–º–æ—Ä–æ–∑–∫–∞</b> ‚Äî –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫—É–±—ã –Ω–∞ 3 —Ö–æ–¥–∞</li>
        <li>‚òÖ <b>–î–∂–æ–∫–µ—Ä</b> ‚Äî –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç—Å—è —Å –ª—é–±—ã–º –∫—É–±–æ–º</li>
        <li>üîÄ <b>–®–∞—Ñ–ª</b> ‚Äî –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–µ—Ç –∫—É–±—ã</li>
      </ul>
    </aside>
    <div style="margin-top:10px;font-size:13px;color:#45636c">
  </div>
</div>
<div id="results-panel" class="results-panel" aria-hidden="true">
  <h3>–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</h3>
  <ul id="results-list"></ul>
  <div style="text-align:right;margin-top:10px">
    <button id="close-results" class="btn btn-danger">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>
<div id="shop-panel" aria-hidden="true">
  <h3 style="color:#fff;text-align:center;margin:0 0 16px 0;font-size:20px;font-weight:700;text-shadow:0 2px 8px rgba(0,0,0,0.5);background:linear-gradient(135deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">üõçÔ∏è –ú–ê–ì–ê–ó–ò–ù –§–û–ù–û–í</h3>
  <div id="shop-items"></div>
  <div style="display:flex;gap:8px;align-items:center;margin-top:16px;justify-content:center">
    <div style="color:#fff;font-size:14px">üí∞ –ë–∞–ª–∞–Ω—Å: <strong id="fake-balance" style="color:#FFD700">0</strong> ‚ÇΩ</div>
    <button onclick="window.milk2048.addMoney(100)" style="background:linear-gradient(135deg,#4CAF50,#45a049);color:#fff;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:12px;margin-left:10px;">+100‚ÇΩ</button>
  </div>
</div>
<div id="victory-modal" class="victory-modal" style="display:none;z-index:2000">
  <div class="victory-content">
    <div style="font-size:80px;margin-bottom:20px;animation:float 2s ease-in-out infinite">üéâ</div>
    <div class="victory-title">–ü–û–ë–ï–î–ê!</div>
    <h2 style="margin:20px 0;color:#FFD700;font-size:24px;">–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ 2048!</h2>
    <div style="background:rgba(255,255,255,0.1);padding:20px;border-radius:16px;margin:20px 0;border:2px solid #FFD700">
      <div style="font-size:32px;color:#FFD700;font-weight:700;margin-bottom:10px">üèÜ –°—á—ë—Ç: <span id="victory-score">0</span></div>
      <div style="font-size:18px;color:#4ECDC4;margin-bottom:5px">‚≠ê –•–æ–¥—ã: <span id="victory-moves">0</span></div>
      <div style="font-size:18px;color:#4ECDC4">‚è±Ô∏è –í—Ä–µ–º—è: <span id="victory-time">00:00</span></div>
    </div>
    <div style="margin-top:30px;">
      <button id="victory-continue" class="tutorial-btn" style="background:linear-gradient(135deg,#4CAF50,#45a049);color:#fff;margin:8px">üöÄ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      <button id="victory-restart" class="tutorial-btn" style="background:linear-gradient(135deg,#FF9800,#e68900);color:#fff;margin:8px">üîÑ –ó–∞–Ω–æ–≤–æ</button>
    </div>
    <div style="margin-top:20px;font-size:14px;color:#aaa;">
      üéä –í—ã –Ω–∞—Å—Ç–æ—è—â–∏–π –º–∞—Å—Ç–µ—Ä 2048! üéä
    </div>
  </div>
</div>

<div id="modal-win" class="modal" aria-hidden="true" style="display:none;">
  <h3>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º ‚Äî 2048!</h3>
  <p>–°—á—ë—Ç: <span id="win-score">0</span></p>
  <div style="text-align:center;margin-top:10px">
    <button id="continue-btn" class="btn primary">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    <button id="close-win" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>
<div id="modal-over" class="modal" aria-hidden="true">
  <h3>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</h3>
  <p>–°—á—ë—Ç: <span id="final-score">0</span></p>
  <div style="text-align:center;margin-top:10px">
    <button id="restart-btn" class="btn primary">–ó–∞–Ω–æ–≤–æ</button>
    <button id="close-over" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>
<div id="bottom-nav" aria-hidden="false">
  <button class="nav-btn active" data-target="game-app"><span>üéÆ</span><div>–ò–≥—Ä–∞</div></button>
  <button class="nav-btn" data-target="shop-panel"><span>üõçÔ∏è</span><div>–ú–∞–≥–∞–∑–∏–Ω</div></button>
  <button class="nav-btn" data-target="results-panel"><span>üìä</span><div>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div></button>
</div>
<script>
const MERGE_SOUND_URL = 'https://actions.google.com/sounds/v1/water/bubble.ogg';
const SWISH_SOUND_URL = 'https://actions.google.com/sounds/v1/office/paper_tear.ogg';
(function(){
  const SIZE = 4;
  const boardEl = document.getElementById('game-board');
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best-score');
  const movesEl = document.getElementById('moves');
  const timeEl = null;
  const resultsList = document.getElementById('results-list');
  const shopItems = document.getElementById('shop-items');
  const chaosTips = document.getElementById('chaos-tips');
  const uploadBg = document.getElementById('upload-bg');
  const welcomeModal = document.getElementById('welcome-modal');
  const mergeSound = new Audio(MERGE_SOUND_URL);
  mergeSound.volume = 0.6;
  const swishSound = new Audio(SWISH_SOUND_URL);
  swishSound.volume = 0.4;
  let grid = []; let tiles = {}; let nextId = 1; let score = 0; let best = parseInt(localStorage.getItem('milk2048_best')||'0',10)||0; let moves = 0; let seconds = 0; let timer = null; let mode = 'classic'; let purchasedBackgrounds = JSON.parse(localStorage.getItem('milk2048_purchased')||'["default"]'); let fakeBalance = parseInt(localStorage.getItem('milk2048_balance')||'0',10); let currentTheme = localStorage.getItem('milk2048_theme') || 'default';
  let frozenTiles = {}; // Track frozen tiles
  let freezeCountdown = 0; // Countdown for freeze effect
  
  // Apply saved theme on load
  function applyTheme(theme) {
    document.body.className = theme === 'default' ? '' : `theme-${theme}`;
    currentTheme = theme;
    localStorage.setItem('milk2048_theme', theme);
    
    // Show/hide bubble gum candies
    const candy1 = document.getElementById('bubblegum-candy-1');
    const candy2 = document.getElementById('bubblegum-candy-2');
    if (theme === 'bubblegum') {
      candy1.style.display = 'block';
      candy2.style.display = 'block';
    } else {
      candy1.style.display = 'none';
      candy2.style.display = 'none';
    }
    
    // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ —Ç–∞—á-—Ç–∞—Ä–≥–µ—Ç—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
    try {
      const isMobile = window.matchMedia && window.matchMedia('(max-width: 520px)').matches;
      const buttons = document.querySelectorAll('.mode-btn, .btn, #bottom-nav .nav-btn');
      buttons.forEach(b=>{
        if(isMobile){ b.style.padding = '12px 16px'; b.style.minHeight = '44px'; b.style.fontSize = '14px'; }
        else { b.style.padding = ''; b.style.minHeight = ''; b.style.fontSize = ''; }
      });
    } catch(e){}
  }
  
  function emptyGrid(){ return Array.from({length:SIZE}, ()=> Array(SIZE).fill(0)); }
  function resetState(){ grid = emptyGrid(); tiles = {}; nextId = 1; score = 0; moves = 0; seconds = 0; frozenTiles = {}; freezeCountdown = 0; }
  function startTimer(){ if(timer) clearInterval(timer); timer=setInterval(()=>{ seconds++; /* time hidden */ },1000); }
  function stopTimer(){ if(timer) clearInterval(timer); timer=null; }
  function formatTime(s){ return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0'); }
  function saveState(){ try{ localStorage.setItem('milk2048_state', JSON.stringify({grid,tiles,nextId,score,best,moves,seconds,mode,frozenTiles,freezeCountdown})); localStorage.setItem('milk2048_best', String(best)); }catch(e){console.warn(e);} }
  function loadState(){ try{ const raw=localStorage.getItem('milk2048_state'); if(!raw) return false; const d=JSON.parse(raw); if(!d) return false; grid=d.grid||emptyGrid(); tiles=d.tiles||{}; nextId=d.nextId||1; score=d.score||0; best=d.best||best; moves=d.moves||0; seconds=d.seconds||0; mode=d.mode||'classic'; frozenTiles=d.frozenTiles||{}; freezeCountdown=d.freezeCountdown||0; return true; }catch(e){return false;} }
  function createTile(value,r,c,specialType=null){ const id='t'+(nextId++); const t={id,value,r,c,specialType,frozen:false}; tiles[id]=t; grid[r][c]=id; return t; }
  
  function addRandom(){ 
    const empties=[]; 
    for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) if(!grid[r][c]) empties.push({r,c}); 
    if(!empties.length) return false; 
    const pos = empties[Math.floor(Math.random()*empties.length)]; 
    let v = Math.random()<0.9?2:4; 
    if(mode==='chaos'){ 
      const r=Math.random(); 
      if(r<0.08){ 
        const types=['bomb','multiplier','freeze','wildcard','shuffle']; 
        const t=types[Math.floor(Math.random()*types.length)]; 
        createTile(0,pos.r,pos.c,t); 
        return true; 
      } 
      if(r<0.15) v = Math.random()<0.5?4:8; 
    } 
    createTile(v,pos.r,pos.c); 
    return true; 
  }
  
  function computeSizes(){
    // –ì–∏–±–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –∏ —Å—Ç—Ä–∞—Ö—É–µ–º—Å—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
    const rect = boardEl.getBoundingClientRect();
    const styles = getComputedStyle(boardEl);
    const gap = parseFloat(styles.getPropertyValue('gap')||16);
    const padding = parseFloat(styles.getPropertyValue('padding')||14);
    const totalGap = gap*(SIZE-1);
    // –ë–µ—Ä—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É, –Ω–æ —Ç–∞–∫–∂–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º—Å—è —à–∏—Ä–∏–Ω–æ–π –≤—å—é–ø–æ—Ä—Ç–∞
    const vwSide = Math.min(window.innerWidth*0.92, rect.width);
    const side = Math.max(0, Math.min(rect.width || vwSide, rect.height || vwSide, vwSide));
    const cell = Math.max(0, (side - padding*2 - totalGap)/SIZE);
    return {cell,gap,padding};
  }
  
  function render(){ 
    boardEl.innerHTML=''; 
    for(let i=0;i<SIZE*SIZE;i++){ 
      const cell = document.createElement('div'); 
      cell.className='cell'; 
      boardEl.appendChild(cell); 
    } 
    const sizes = computeSizes(); 
    const cellSize = sizes.cell, gap=sizes.gap, padding=sizes.padding; 
    Object.values(tiles).forEach(t=>{ 
      if(!t) return; 
      if(t.value<=0 && !t.specialType) return; 
      let el = document.querySelector('[data-id="'+t.id+'"]'); 
      const existed = !!el; 
      if(!el){ 
        el = document.createElement('div'); 
        el.dataset.id = t.id; 
        boardEl.appendChild(el); 
      } 
      if(t.specialType) el.className = 'tile chaos-'+t.specialType; 
      else el.className = 'tile v'+t.value; 
      if(t.value===1024) el.classList.add('v1024'); 
      else el.classList.remove('v1024'); 
      if(t.value>=2048) el.classList.add('v2048'); 
      else el.classList.remove('v2048'); 
      if(t.value>=4096) el.classList.add('legendary'); 
      else el.classList.remove('legendary'); 
      if(t.frozen || frozenTiles[t.id]) el.classList.add('frozen'); 
      else el.classList.remove('frozen'); 
      el.textContent = t.specialType? '': (t.value>0? t.value : ''); 
      const x = Math.round(padding + (cellSize+gap)*t.c); 
      const y = Math.round(padding + (cellSize+gap)*t.r); 
      el.style.setProperty('--tile-x', x+'px'); 
      el.style.setProperty('--tile-y', y+'px'); 
      el.style.width = Math.max(0, Math.floor(cellSize))+'px'; 
      el.style.height = Math.max(0, Math.floor(cellSize))+'px'; 
      el.style.transform = 'translate('+x+'px,'+y+'px)'; 
      el.style.willChange = 'transform'; 
      el.style.transitionTimingFunction = 'cubic-bezier(0.22, 1, 0.36, 1)'; 
      el.style.transitionDuration = '400ms'; 
      if(!existed){ 
        el.classList.add('new'); 
        setTimeout(()=>el.classList.remove('new'), 420); 
      } 
    }); 
    scoreEl.textContent = score; 
    bestEl.textContent = best; 
    movesEl.textContent = moves; 
  }
  
  function canMove(){ 
    for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) if(!grid[r][c]) return true; 
    for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++){ 
      const id = grid[r][c]; 
      if(!id) continue; 
      const t = tiles[id]; 
      if(!t || t.specialType) continue; 
      const v = t.value; 
      const dirs = [[1,0],[0,1]]; 
      for(const d of dirs){ 
        const rr=r+d[0], cc=c+d[1]; 
        if(rr<0||rr>=SIZE||cc<0||cc>=SIZE) continue; 
        const id2 = grid[rr][cc]; 
        if(!id2) continue; 
        const t2 = tiles[id2]; 
        if(!t2 || t2.specialType) continue; 
        if(t2.value===v) return true; 
      } 
    } 
    return false; 
  }
  
  // Handle special tiles effects
  function handleSpecialTile(tile, r, c) {
    if (!tile.specialType) return;
    
    switch(tile.specialType) {
      case 'bomb':
        // Destroy adjacent tiles
        for(let dr = -1; dr <= 1; dr++) {
          for(let dc = -1; dc <= 1; dc++) {
            const nr = r + dr, nc = c + dc;
            if(nr >= 0 && nr < SIZE && nc >= 0 && nc < SIZE) {
              const adjId = grid[nr][nc];
              if(adjId && adjId !== tile.id) {
                delete tiles[adjId];
                grid[nr][nc] = 0;
              }
            }
          }
        }
        break;
        
      case 'multiplier':
        // Double adjacent tiles
        for(let dr = -1; dr <= 1; dr++) {
          for(let dc = -1; dc <= 1; dc++) {
            const nr = r + dr, nc = c + dc;
            if(nr >= 0 && nr < SIZE && nc >= 0 && nc < SIZE) {
              const adjId = grid[nr][nc];
              if(adjId && adjId !== tile.id) {
                const adjTile = tiles[adjId];
                if(adjTile && !adjTile.specialType && adjTile.value > 0) {
                  adjTile.value *= 2;
                  score += adjTile.value;
                }
              }
            }
          }
        }
        break;
        
      case 'freeze':
        // Freeze all tiles for 3 moves
        freezeCountdown = 3;
        Object.keys(tiles).forEach(id => {
          if(tiles[id] && !tiles[id].specialType) {
            frozenTiles[id] = true;
          }
        });
        break;
        
      case 'shuffle':
        // Shuffle all tiles
        const allTiles = Object.values(tiles).filter(t => t && (t.value > 0 || t.specialType));
        const positions = [];
        for(let r = 0; r < SIZE; r++) {
          for(let c = 0; c < SIZE; c++) {
            if(grid[r][c]) positions.push({r, c});
          }
        }
        
        // Clear grid
        grid = emptyGrid();
        
        // Shuffle positions
        for(let i = positions.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [positions[i], positions[j]] = [positions[j], positions[i]];
        }
        
        // Reassign tiles to shuffled positions
        allTiles.forEach((tile, index) => {
          if(positions[index]) {
            tile.r = positions[index].r;
            tile.c = positions[index].c;
            grid[tile.r][tile.c] = tile.id;
          }
        });
        break;
    }
    
    // Remove the special tile after use
    delete tiles[tile.id];
    grid[r][c] = 0;
  }
  
  // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–í–ò–ñ–ï–ù–ò–Ø
  function moveLeft(){ 
    let moved=false; 
    for(let r=0;r<SIZE;r++){ 
      const row=[]; 
      for(let c=0;c<SIZE;c++){ 
        const id=grid[r][c]; 
        row.push(id?tiles[id]:null); 
      } 
      const compact = row.filter(x=>x && (x.value>0 || x.specialType)); 
      const processed = []; 
      for(let i=0;i<compact.length;i++){ 
        if(i+1<compact.length && !compact[i].specialType && !compact[i+1].specialType && compact[i].value>0 && compact[i].value===compact[i+1].value && !frozenTiles[compact[i].id] && !frozenTiles[compact[i+1].id]){ 
          compact[i].value *= 2; 
          score += compact[i].value; 
          if(score>best){ 
            best = score; 
            localStorage.setItem('milk2048_best', String(best)); 
          } 
          delete tiles[compact[i+1].id]; 
          try{ 
            mergeSound.currentTime=0; 
            mergeSound.play(); 
          }catch(e){} 
          processed.push(compact[i]); 
          i++; 
        } else { 
          processed.push(compact[i]); 
        } 
      } 
      while(processed.length<SIZE) processed.push(null); 
      for(let c=0;c<SIZE;c++){ 
        const item = processed[c]; 
        const prev = grid[r][c]; 
        if(item){ 
          grid[r][c]=item.id; 
          item.r=r; 
          item.c=c; 
          // Handle special tiles
          if(item.specialType) {
            handleSpecialTile(item, r, c);
          }
        } else { 
          grid[r][c]=0; 
        } 
        if(prev !== grid[r][c]) moved = true; 
      } 
    } 
    return moved; 
  }

  
  function moveUp(){
    let moved = false;
    for(let c=0;c<SIZE;c++){
      const nonEmpty = [];
      for(let r=0;r<SIZE;r++){
        const id = grid[r][c];
        if(id) nonEmpty.push(tiles[id]);
      }
      const merged = [];
      for(let i=0;i<nonEmpty.length;i++){
        const a = nonEmpty[i];
        const b = nonEmpty[i+1];
        if(b && !a.specialType && !b.specialType && a.value === b.value && !frozenTiles[a.id] && !frozenTiles[b.id]){
          a.value *= 2;
          score += a.value;
          if(score>best){ best = score; localStorage.setItem('milk2048_best', String(best)); }
          delete tiles[b.id];
          i++;
        }
        merged.push(a);
      }
      while(merged.length < SIZE) merged.push(null);
      for(let r=0;r<SIZE;r++){
        const item = merged[r];
        const prev = grid[r][c];
        if(item){
          grid[r][c] = item.id;
          item.r = r;
          item.c = c;
          if(item.specialType) {
            handleSpecialTile(item, r, c);
          }
        } else grid[r][c] = 0;
        if(prev !== grid[r][c]) moved = true;
      }
    }
    return moved;
  }


  function moveRight(){
    let moved = false;
    for(let r=0;r<SIZE;r++){
      const row = [];
      for(let c=SIZE-1;c>=0;c--){
        const id = grid[r][c];
        row.push(id ? tiles[id] : null);
      }
      const compact = row.filter(x => x && (x.value > 0 || x.specialType));
      const processed = [];
      for(let i=0;i<compact.length;i++){
        if(i+1<compact.length && !compact[i].specialType && !compact[i+1].specialType && compact[i].value>0 && compact[i].value===compact[i+1].value && !frozenTiles[compact[i].id] && !frozenTiles[compact[i+1].id]){
          compact[i].value *= 2;
          score += compact[i].value;
          if(score>best){
            best = score;
            localStorage.setItem('milk2048_best', String(best));
          }
          delete tiles[compact[i+1].id];
          try{
            mergeSound.currentTime=0;
            mergeSound.play();
          }catch(e){}
          processed.push(compact[i]);
          i++;
        } else {
          processed.push(compact[i]);
        }
      }
      while(processed.length<SIZE) processed.push(null);
      for(let c=0;c<SIZE;c++){
        const item = processed[c];
        const actualCol = SIZE-1-c;
        const prev = grid[r][actualCol];
        if(item){
          grid[r][actualCol] = item.id;
          item.r = r;
          item.c = actualCol;
          if(item.specialType) {
            handleSpecialTile(item, r, actualCol);
          }
        } else {
          grid[r][actualCol] = 0;
        }
        if(prev !== grid[r][actualCol]) moved = true;
      }
    }
    return moved;
  }

  
  function moveDown(){
    let moved = false;
    for(let c=0;c<SIZE;c++){
      const nonEmpty = [];
      for(let r=SIZE-1;r>=0;r--){
        const id = grid[r][c];
        if(id) nonEmpty.push(tiles[id]);
      }
      const merged = [];
      for(let i=0;i<nonEmpty.length;i++){
        const a = nonEmpty[i];
        const b = nonEmpty[i+1];
        if(b && !a.specialType && !b.specialType && a.value === b.value && !frozenTiles[a.id] && !frozenTiles[b.id]){
          a.value *= 2;
          score += a.value;
          if(score>best){ best = score; localStorage.setItem('milk2048_best', String(best)); }
          delete tiles[b.id];
          i++;
        }
        merged.push(a);
      }
      while(merged.length < SIZE) merged.push(null);
      for(let r=0;r<SIZE;r++){
        const item = merged[r];
        const targetR = SIZE-1-r;
        const prev = grid[targetR][c];
        if(item){
          grid[targetR][c] = item.id;
          item.r = targetR;
          item.c = c;
          if(item.specialType) {
            handleSpecialTile(item, targetR, c);
          }
        } else grid[targetR][c] = 0;
        if(prev !== grid[targetR][c]) moved = true;
      }
    }
    return moved;
  }


  function doMove(dir){ 
    let moved = false; 
    if(dir === 'up'){ 
      moved = moveUp(); 
    } else if(dir === 'right'){ 
      moved = moveRight(); 
    } else if(dir === 'down'){ 
      moved = moveDown(); 
    } else if(dir === 'left'){ 
      moved = moveLeft(); 
    } 
    
    if(moved) {
      moves++;
      
      // Handle freeze countdown
      if(freezeCountdown > 0) {
        freezeCountdown--;
        if(freezeCountdown === 0) {
          frozenTiles = {};
        }
      }
      
      setTimeout(()=>{ 
        addRandom(); 
        render(); 
        saveState(); 
        if(!canMove()){ 
          showGameOver(); 
        } 
        if(checkWin()){ 
          showWin(); 
        } 
      }, 90); 
    }
    return moved; 
  }
  
  function postMove(){ moves++; setTimeout(()=>{ addRandom(); render(); saveState(); if(!canMove()){ showGameOver(); } if(checkWin()){ showWin(); } }, 90); }
  function checkWin(){ return Object.values(tiles).some(t=>t && !t.specialType && t.value>=2048); }
  function showWin(){ 
    // –ù–∞–π—Ç–∏ –ø–ª–∏—Ç–∫—É 2048 –∏ —Å–æ–∑–¥–∞—Ç—å –≤–∑—Ä—ã–≤
    Object.values(tiles).forEach(tile => {
      if(tile && tile.value >= 2048){
        const tileEl = document.querySelector(`[data-id="${tile.id}"]`);
        if(tileEl){
          const rect = tileEl.getBoundingClientRect();
          const centerX = rect.left + rect.width/2;
          const centerY = rect.top + rect.height/2;
          // –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é –≤–∑—Ä—ã–≤–∞ –∫ –ø–ª–∏—Ç–∫–µ
          tileEl.style.animation = 'explosion 1.5s ease-out forwards';
          // –°–æ–∑–¥–∞—Ç—å –≤–∑—Ä—ã–≤ —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫—É–Ω–¥—ã
          setTimeout(() => createExplosion(centerX, centerY), 500);
        }
      }
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –ø–æ–±–µ–¥—ã —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
      document.getElementById('victory-score').textContent = score;
      document.getElementById('victory-moves').textContent = moves;
      document.getElementById('victory-time').textContent = formatTime(seconds);
      document.getElementById('victory-modal').style.display='flex';
      launchConfetti();
      saveHistory();
    }, 2000);
  }
  function showGameOver(){ document.getElementById('final-score').textContent = score; document.getElementById('modal-over').style.display='block'; document.getElementById('modal-over').setAttribute('aria-hidden','false'); saveHistory(); }
  function saveHistory(){ try{ const hist = JSON.parse(localStorage.getItem('milk2048_history')||'[]'); hist.push({date:new Date().toLocaleString(), score, moves, time: formatTime(seconds), mode}); localStorage.setItem('milk2048_history', JSON.stringify(hist)); populateResults(); }catch(e){} }
  function populateResults(){ if(!resultsList) return; resultsList.innerHTML=''; const arr = JSON.parse(localStorage.getItem('milk2048_history')||'[]').slice().reverse(); let idx=0; for(const it of arr){ if(it.score<1000) continue; idx++; const li=document.createElement('li'); li.className='results-list-item'; const rank=document.createElement('div'); rank.className='rank'; rank.textContent = idx; const info=document.createElement('div'); info.className='info'; info.innerHTML = '<div style="font-weight:800">'+it.score+' pts</div><div style="font-size:12px;color:#45636c">'+it.date+' ‚Ä¢ '+it.mode+' ‚Ä¢ '+it.time+'</div>'; li.appendChild(rank); li.appendChild(info); if(idx===1) li.classList.add('gold-card'); else if(idx===2) li.classList.add('silver-card'); else if(idx===3) li.classList.add('bronze-card'); resultsList.appendChild(li); } }
  document.addEventListener('keydown', e=>{ if(e.key==='ArrowLeft') doMove('left'); if(e.key==='ArrowRight') doMove('right'); if(e.key==='ArrowUp') doMove('up'); if(e.key==='ArrowDown') doMove('down'); if(e.key.toLowerCase()==='u'){ Object.values(tiles).forEach(t=>{ if(t && t.value>0 && !t.specialType) t.value*=4; }); render(); saveState(); populateResults(); } });
  (function(){ let sx=0, sy=0, st=0; boardEl.addEventListener('touchstart', e=>{ const t = e.changedTouches[0]; sx=t.clientX; sy=t.clientY; st=Date.now(); }, {passive:true}); boardEl.addEventListener('touchend', e=>{ const t = e.changedTouches[0]; const dx = t.clientX - sx; const dy = t.clientY - sy; const dt = Date.now() - st; if(dt<700){ if(Math.abs(dx)>Math.abs(dy) && Math.abs(dx)>30){ if(dx>0) doMove('right'); else doMove('left'); } else if(Math.abs(dy)>30){ if(dy>0) doMove('down'); else doMove('up'); } } }, {passive:true}); })();
  function playSwishSound(){ try{ swishSound.currentTime=0; swishSound.play(); }catch(e){} }
  function updateBalance(){ document.getElementById('fake-balance').textContent = fakeBalance; localStorage.setItem('milk2048_balance', String(fakeBalance)); }
  function addMoney(amount){ fakeBalance += amount; updateBalance(); }
  function purchaseBackground(bgKey){ if(purchasedBackgrounds.includes(bgKey)) return true; if(fakeBalance >= 49){ fakeBalance -= 49; purchasedBackgrounds.push(bgKey); localStorage.setItem('milk2048_purchased', JSON.stringify(purchasedBackgrounds)); updateBalance(); return true; } return false; }
  function isPurchased(bgKey){ return purchasedBackgrounds.includes(bgKey); }
  
  function simulatePayment(bgKey, bgTitle){ 
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); z-index: 1000; display: flex; 
      align-items: center; justify-content: center; font-family: inherit;
    `;
    
    const paymentBox = document.createElement('div');
    paymentBox.style.cssText = `
      background: linear-gradient(145deg, #1a1a2e 0%, #16213e 50%, #0f1419 100%);
      border: 2px solid #FFD700; border-radius: 20px; padding: 30px;
      max-width: 400px; width: 90%; text-align: center; color: #fff;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 30px rgba(255,215,0,0.3);
    `;
    
    paymentBox.innerHTML = `
      <h3 style="margin: 0 0 20px 0; color: #FFD700; font-size: 24px;">üí≥ –ü–æ–∫—É–ø–∫–∞ —Ç–µ–º—ã</h3>
      <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin: 20px 0;">
        <div style="font-size: 18px; margin-bottom: 10px;">${bgTitle}</div>
        <div style="font-size: 32px; color: #FFD700; font-weight: 700;">49 ‚ÇΩ</div>
      </div>
      <div style="margin: 20px 0; font-size: 14px; color: #aaa;">
        –ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ —Ç–µ–º–∞ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="closePaymentModal();" style="flex: 1; background: #666; color: #fff; border: none; padding: 12px; border-radius: 8px; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
        <button onclick="processPayment('${bgKey}', '${bgTitle}');" style="flex: 1; background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 700;">–ö—É–ø–∏—Ç—å</button>
      </div>
    `;
    
    modal.appendChild(paymentBox);
    document.body.appendChild(modal);
    
    window.closePaymentModal = () => { document.body.removeChild(modal); };
    window.processPayment = (key, title) => {
      if(fakeBalance >= 49) {
        // –£—Å–ø–µ—à–Ω–∞—è –ø–æ–∫—É–ø–∫–∞
        fakeBalance -= 49;
        purchasedBackgrounds.push(key);
        localStorage.setItem('milk2048_purchased', JSON.stringify(purchasedBackgrounds));
        updateBalance();
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
        applyTheme(key);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showSuccessNotification(`‚úÖ –¢–µ–º–∞ "${title}" –∫—É–ø–ª–µ–Ω–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!`);
        
        document.body.removeChild(modal);
        populateShop();
      } else {
        // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
        showErrorNotification('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤! –ù–∞–∂–º–∏—Ç–µ +100‚ÇΩ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –¥–µ–Ω—å–≥–∏.');
      }
    };
  }
  
  function showSuccessNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed; top: 20px; right: 20px; z-index: 3000;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white; padding: 16px 24px; border-radius: 12px;
      font-weight: 700; box-shadow: 0 8px 32px rgba(76,175,80,0.4);
      animation: slideInRight 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
    `
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
  }
  
  function showErrorNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed; top: 20px; right: 20px; z-index: 3000;
      background: linear-gradient(135deg, #f44336, #d32f2f);
      color: white; padding: 16px 24px; border-radius: 12px;
      font-weight: 700; box-shadow: 0 8px 32px rgba(244,67,54,0.4);
      animation: slideInRight 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
  }
  
  function createExplosion(x, y){ const explosion = document.createElement('div'); explosion.style.position='fixed'; explosion.style.left=x+'px'; explosion.style.top=y+'px'; explosion.style.width='100px'; explosion.style.height='100px'; explosion.style.pointerEvents='none'; explosion.style.zIndex=9998; explosion.style.transform='translate(-50%, -50%)'; document.body.appendChild(explosion); for(let i=0;i<20;i++){ const particle = document.createElement('div'); particle.className='explosion-particle'; const angle = (i/20)*Math.PI*2; const distance = 50 + Math.random()*50; particle.style.left = (50 + Math.cos(angle)*distance) + 'px'; particle.style.top = (50 + Math.sin(angle)*distance) + 'px'; particle.style.animationDelay = Math.random()*0.5 + 's'; explosion.appendChild(particle); } setTimeout(()=> explosion.remove(), 1500); }
  function createFireworks(){ for(let i=0;i<15;i++){ setTimeout(()=>{ const firework = document.createElement('div'); firework.className='firework'; firework.style.left = Math.random()*100+'%'; firework.style.top = '100vh'; firework.style.zIndex = 9999; document.body.appendChild(firework); setTimeout(()=> firework.remove(), 3000); }, i*200); } }
  function launchMegaConfetti(){ const conf = document.createElement('div'); conf.style.position='fixed'; conf.style.left=0; conf.style.top=0; conf.style.width='100%'; conf.style.height='100%'; conf.style.pointerEvents='none'; conf.style.zIndex=9999; document.body.appendChild(conf); const emojis=['üéâ','‚ú®','üí´','üåü','ü•≥','üéä','üéà','üèÜ','üëë','üíé','‚≠ê','üî•']; for(let i=0;i<80;i++){ const s=document.createElement('div'); s.textContent=emojis[Math.floor(Math.random()*emojis.length)]; s.style.position='absolute'; s.style.left = Math.random()*100+'%'; s.style.top = '-10%'; s.style.fontSize = (15+Math.random()*40)+'px'; s.style.transition = 'all 3s cubic-bezier(0.25,0.46,0.45,0.94)'; s.style.animation = 'float 2s ease-in-out infinite'; conf.appendChild(s); setTimeout(()=>{ s.style.top = (120+Math.random()*30)+'%'; s.style.transform = 'rotate('+ (Math.random()*1080-540) +'deg) scale('+ (0.5+Math.random()*1.5) +')'; s.style.opacity = 0; }, 50 + i*30); } setTimeout(()=> conf.remove(), 4000); }
  function launchConfetti(){ launchMegaConfetti(); createFireworks(); }
  document.getElementById('new-game-btn')?.addEventListener('click', () => {resetState();addRandom();addRandom();render();saveState();startTimer();});
  document.getElementById('mode-classic')?.addEventListener('click', ()=>{ mode='classic'; document.getElementById('mode-classic').classList.add('active'); document.getElementById('mode-chaos').classList.remove('active'); chaosTips.style.display='none'; saveState(); });
  document.getElementById('mode-chaos')?.addEventListener('click', ()=>{ mode='chaos'; document.getElementById('mode-chaos').classList.add('active'); document.getElementById('mode-classic').classList.remove('active'); chaosTips.style.display='block'; saveState(); });
  document.getElementById('close-results')?.addEventListener('click', ()=>{ document.getElementById('results-panel').style.display='none'; document.querySelectorAll('#bottom-nav .nav-btn').forEach(b=>b.classList.remove('active')); document.querySelector('#bottom-nav .nav-btn[data-target="game-app"]').classList.add('active'); });
  document.getElementById('results-panel')?.addEventListener('click', (e)=>{ if(e.target === document.getElementById('results-panel')){ document.getElementById('results-panel').style.display='none'; document.querySelectorAll('#bottom-nav .nav-btn').forEach(b=>b.classList.remove('active')); document.querySelector('#bottom-nav .nav-btn[data-target="game-app"]').classList.add('active'); } });
  document.getElementById('close-win')?.addEventListener('click', ()=>{ document.getElementById('modal-win').style.display='none'; });
  document.getElementById('victory-continue')?.addEventListener('click', ()=>{ document.getElementById('victory-modal').style.display='none'; });
  document.getElementById('victory-restart')?.addEventListener('click', ()=>{ document.getElementById('victory-modal').style.display='none'; resetState(); addRandom(); addRandom(); render(); saveState(); startTimer(); });
  document.getElementById('continue-btn')?.addEventListener('click', ()=>{ document.getElementById('modal-win').style.display='none'; });
  document.getElementById('restart-btn')?.addEventListener('click', ()=>{ document.getElementById('modal-over').style.display='none'; resetState(); addRandom(); addRandom(); render(); saveState(); startTimer(); });
  document.getElementById('close-over')?.addEventListener('click', ()=>{ document.getElementById('modal-over').style.display='none'; });
  document.querySelectorAll('#bottom-nav .nav-btn').forEach(btn=>{
    const handler = ()=>{ 
      playSwishSound(); 
      document.querySelectorAll('#bottom-nav .nav-btn').forEach(b=>b.classList.remove('active')); 
      btn.classList.add('active'); 
      document.getElementById('shop-panel').style.display='none'; 
      document.getElementById('results-panel').style.display='none'; 
      const target = btn.getAttribute('data-target'); 
      if(target==='game-app'){ document.getElementById('game-app').style.display='block'; } 
      else { document.getElementById('game-app').style.display='block'; document.getElementById(target).style.display='block'; } 
    };
    btn.addEventListener('click', handler, {passive:true});
    btn.addEventListener('touchstart', (e)=>{ e.preventDefault(); handler(); }, {passive:false});
  });
  
  function populateShop(){ 
    shopItems.innerHTML=''; 
    const choices=[
      {key:'default',title:'–°—Ç–∞–Ω–¥–∞—Ä—Ç',rarity:'common',icon:'üåü',preview:'linear-gradient(135deg, #dceffb 0%, #f7d7ff 60%)'},
      {key:'ocean',title:'–û–∫–µ–∞–Ω',rarity:'rare',icon:'üåä',preview:'linear-gradient(135deg,#b3e5fc 0%,#4fc3f7 70%)'},
      {key:'coral',title:'–ö–æ—Ä–∞–ª–ª—ã',rarity:'epic',icon:'ü™∏',preview:'linear-gradient(135deg,#ffe6d6 0%,#ffd6c5 70%)'},
      {key:'forest',title:'–õ–µ—Å',rarity:'rare',icon:'üå≤',preview:'linear-gradient(135deg,#c8e6c9 0%,#81c784 70%)'},
      {key:'space',title:'–ö–æ—Å–º–æ—Å',rarity:'legendary',icon:'üåå',preview:'linear-gradient(135deg,#1a1a2e 0%,#0f1419 70%)'},
      {key:'bubblegum',title:'Bubble Gum',rarity:'epic',icon:'üç≠',preview:'linear-gradient(135deg,#ffd1e8 0%,#ff8ac6 70%)'}
    ]; 
    
    choices.forEach((it, index)=>{
      const card = document.createElement('div');
      card.className = 'shop-card clash-style';
      
      // Rarity-based styling
      let rarityClass = 'common';
      let glowColor = '#9CA3AF';
      let borderColor = '#6B7280';
      
      switch(it.rarity) {
        case 'rare': 
          rarityClass = 'rare'; 
          glowColor = '#3B82F6'; 
          borderColor = '#1D4ED8';
          break;
        case 'epic': 
          rarityClass = 'epic'; 
          glowColor = '#8B5CF6'; 
          borderColor = '#7C3AED';
          break;
        case 'legendary': 
          rarityClass = 'legendary'; 
          glowColor = '#F59E0B'; 
          borderColor = '#D97706';
          break;
      }
      
      const isOwned = isPurchased(it.key);
      const isActive = currentTheme === it.key;
      
      card.style.cssText = `
        width: 100%;
        height: 180px;
        background: linear-gradient(145deg, #1a1a2e 0%, #16213e 50%, #0f1419 100%);
        border: 3px solid ${isActive ? '#4CAF50' : borderColor};
        border-radius: 16px;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 20px ${isActive ? '#4CAF50' : glowColor}40;
        transform: translateY(0);
        animation: slideInUp 0.6s ease-out ${index * 0.1}s both;
      `;
      
      // Active indicator
      if(isActive) {
        const activeIndicator = document.createElement('div');
        activeIndicator.style.cssText = `
          position: absolute; top: 8px; left: 8px; z-index: 10;
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: white; padding: 4px 8px; border-radius: 12px;
          font-size: 10px; font-weight: 700;
        `;
        activeIndicator.textContent = '‚úì –ê–ö–¢–ò–í–ù–ê';
        card.appendChild(activeIndicator);
      }
      
      // Glow effect
      const glow = document.createElement('div');
      glow.style.cssText = `
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, ${isActive ? '#4CAF50' : glowColor}, transparent, ${isActive ? '#4CAF50' : glowColor});
        border-radius: 18px;
        opacity: 0.6;
        z-index: -1;
        filter: blur(8px);
      `;
      card.appendChild(glow);
      
      // Preview area
      const preview = document.createElement('div');
      preview.style.cssText = `
        width: 100%;
        height: 100px;
        background: ${it.preview};
        border-radius: 12px 12px 0 0;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        text-shadow: 0 2px 8px rgba(0,0,0,0.3);
      `;
      preview.textContent = it.icon;
      card.appendChild(preview);
      
      // Title area
      const titleArea = document.createElement('div');
      titleArea.style.cssText = `
        padding: 8px;
        background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.2) 100%);
        height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
      `;
      
      const title = document.createElement('div');
      title.style.cssText = `
        color: #fff;
        font-size: 14px;
        font-weight: 700;
        text-align: center;
        margin-bottom: 4px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      `;
      title.textContent = it.title;
      
      const rarity = document.createElement('div');
      rarity.style.cssText = `
        color: ${glowColor};
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      `;
      rarity.textContent = it.rarity.toUpperCase();
      
      const price = document.createElement('div');
      price.style.cssText = `
        position: absolute;
        top: 8px;
        right: 8px;
        background: ${isOwned ? 'linear-gradient(135deg, #4CAF50, #45a049)' : 'linear-gradient(135deg, #FFD700, #FFA500)'};
        color: ${isOwned ? '#fff' : '#000'};
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(255,215,0,0.3);
      `;
      price.textContent = isOwned ? '‚úì –ö–£–ü–õ–ï–ù–ê' : '49 ‚ÇΩ';
      
      titleArea.appendChild(title);
      titleArea.appendChild(rarity);
      titleArea.appendChild(price);
      card.appendChild(titleArea);
      
      // Hover effects
      card.addEventListener('mouseenter', () => {
        card.style.transform = 'translateY(-8px) scale(1.02)';
        card.style.boxShadow = `0 16px 48px rgba(0,0,0,0.4), 0 0 30px ${isActive ? '#4CAF50' : glowColor}60`;
        glow.style.opacity = '1';
      });
      
      card.addEventListener('mouseleave', () => {
        card.style.transform = 'translateY(0) scale(1)';
        card.style.boxShadow = `0 8px 32px rgba(0,0,0,0.3), 0 0 20px ${isActive ? '#4CAF50' : glowColor}40`;
        glow.style.opacity = '0.6';
      });
      
      // Click handler
      card.addEventListener('click', () => {
        playSwishSound();
        const isOwned = isPurchased(it.key);
        
        if(isOwned) {
          // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É –µ—Å–ª–∏ –æ–Ω–∞ –∫—É–ø–ª–µ–Ω–∞
          applyTheme(it.key);
          showSuccessNotification(`‚úÖ –¢–µ–º–∞ "${it.title}" –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!`);
          populateShop(); // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–≥–∞–∑–∏–Ω —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é —Ç–µ–º—É
        } else {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ–∫—É–ø–∫–∏
          simulatePayment(it.key, it.title);
        }
        
        // Visual feedback
        card.style.transform = 'scale(0.95)';
        setTimeout(() => {
          card.style.transform = 'translateY(-8px) scale(1.02)';
        }, 100);
      });
      
      shopItems.appendChild(card);
    });
  }
  
  // Add CSS for notifications
  const notificationCSS = document.createElement('style');
  notificationCSS.textContent = `
    @keyframes slideInRight {
      0% { transform: translateX(100%); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }
  `;
  document.head.appendChild(notificationCSS);
  
  document.getElementById('tutorial-start')?.addEventListener('click', ()=>{ 
    playSwishSound();
    document.getElementById('tutorial-modal').style.display='none'; 
    document.getElementById('game-app').style.display='block'; 
    launchConfetti();
  });
  document.getElementById('tutorial-shop')?.addEventListener('click', ()=>{ 
    playSwishSound();
    document.getElementById('tutorial-modal').style.display='none'; 
    document.getElementById('shop-panel').style.display='block'; 
    document.querySelectorAll('#bottom-nav .nav-btn').forEach(b=>b.classList.remove('active')); 
    document.querySelector('#bottom-nav .nav-btn[data-target="shop-panel"]').classList.add('active'); 
  });
  
  document.getElementById('tutorial-skip')?.addEventListener('click', ()=>{ 
    playSwishSound();
    document.getElementById('tutorial-modal').style.display='none';
    document.getElementById('game-app').style.display='block';
  });
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–±—É—á–µ–Ω–∏—è –∫–ª–∏–∫–æ–º –≤–Ω–µ –æ–∫–Ω–∞
  document.getElementById('tutorial-modal')?.addEventListener('click', (e)=>{
    if(e.target === document.getElementById('tutorial-modal')){
      playSwishSound();
      document.getElementById('tutorial-modal').style.display='none';
      document.getElementById('game-app').style.display='block';
    }
  });
  
  // Initialize
  const loaded = loadState(); 
  if(!loaded){ resetState(); addRandom(); addRandom(); } 
  updateBalance(); 
  populateShop(); 
  render(); 
  populateResults(); 
  startTimer(); 
  setInterval(saveState, 5000); 
  
  // Apply saved theme
  applyTheme(currentTheme);

  // Create candy images for bubble gum theme
  const candyDataUrl = 'data:image/svg+xml;base64,' + btoa(`
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="200" viewBox="0 0 100 200">
      <defs>
        <radialGradient id="candyGrad" cx="50%" cy="40%" r="60%">
          <stop offset="0%" style="stop-color:#ff79b0;stop-opacity:1" />
          <stop offset="70%" style="stop-color:#ff5fa1;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#e83e86;stop-opacity:1" />
        </radialGradient>
        <linearGradient id="stickGrad" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#ffd700;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#ffae00;stop-opacity:1" />
        </linearGradient>
      </defs>
      <circle cx="50" cy="60" r="35" fill="url(#candyGrad)" stroke="#ff4f95" stroke-width="2"/>
      <circle cx="50" cy="60" r="25" fill="rgba(255,255,255,0.3)"/>
      <circle cx="45" cy="55" r="8" fill="rgba(255,255,255,0.6)"/>
      <rect x="47" y="95" width="6" height="100" fill="url(#stickGrad)" stroke="#e6ac00" stroke-width="1"/>
    </svg>
  `);
  
  document.getElementById('bubblegum-candy-1').src = candyDataUrl;
  document.getElementById('bubblegum-candy-2').src = candyDataUrl;
  
  // Export essential APIs to window so external systems (audio) can patch safely
  window.milk2048 = { resetState, render, addMoney, applyTheme, doMove };
})();

/* ==== SOUND SYSTEM BY THEME ==== */
// –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∑–≤—É–∫–∏ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
window.__milk2048_themeAudio?.cleanup?.();

const themeSounds = {
  default: {
    bg: null, // No background music for default theme
    move: new Audio('https://actions.google.com/sounds/v1/water/bubble.ogg')
  },
  ocean: {
    bg: new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_ebd01d6a64.mp3?filename=ocean-waves-ambient.mp3'),
    move: new Audio('https://actions.google.com/sounds/v1/water/water_droplet_on_water.ogg')
  },
  forest: {
    bg: new Audio('https://cdn.pixabay.com/download/audio/2021/08/04/audio_07e1d48d10.mp3?filename=forest-birds.mp3'),
    move: new Audio('https://actions.google.com/sounds/v1/foley/rustling_leaves.ogg')
  },
  space: {
    bg: new Audio('https://cdn.pixabay.com/download/audio/2022/02/16/audio_8e1f16e7a3.mp3?filename=deep-space-hum.mp3'),
    move: new Audio('https://actions.google.com/sounds/v1/sci_fi/laser_beam.ogg')
  },
  bubblegum: {
    bg: new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg'),
    move: new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg')
  }
};

for (const theme of Object.keys(themeSounds)) {
  const sounds = themeSounds[theme];
  if (sounds.bg) {
    sounds.bg.loop = true;
    sounds.bg.volume = 0.25; // —á—É—Ç—å —Ç–∏—à–µ, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å
  }
  if (sounds.move) {
    sounds.move.volume = 0.55;
  }
}

function playThemeSound(theme) {
  // Stop all background sounds
  Object.values(themeSounds).forEach(s => {
    if (s.bg) s.bg.pause();
  });
  
  // Play background for current theme
  if (themeSounds[theme] && themeSounds[theme].bg) {
    themeSounds[theme].bg.currentTime = 0;
    themeSounds[theme].bg.play().catch(()=>{});
  }
}

function playMoveSound() {
  try {
    const theme = (localStorage.getItem('milk2048_theme') || 'default');
    if (themeSounds[theme] && themeSounds[theme].move) {
      themeSounds[theme].move.currentTime = 0;
      themeSounds[theme].move.play().catch(()=>{});
    }
  } catch(e) {}
}

// –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–∞—Ç—á–∏–º doMove –æ–¥–∏–Ω —Ä–∞–∑
if(!window.__milk2048_themeAudio){ window.__milk2048_themeAudio = {}; }
if(!window.__milk2048_themeAudio.patchedMove && window.milk2048 && typeof window.milk2048.doMove === 'function'){
  const origDoMove = window.milk2048.doMove;
  window.milk2048.doMove = function(dir){
    const moved = origDoMove(dir);
    if (moved) playMoveSound();
    return moved;
  };
  window.__milk2048_themeAudio.patchedMove = true;
}

// –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–∞—Ç—á–∏–º applyTheme –æ–¥–∏–Ω —Ä–∞–∑
if(!window.__milk2048_themeAudio.patchedTheme && window.milk2048 && typeof window.milk2048.applyTheme === 'function'){
  const origApplyTheme = window.milk2048.applyTheme;
  window.milk2048.applyTheme = function(theme){
    origApplyTheme(theme);
    playThemeSound(theme);
  };
  window.__milk2048_themeAudio.patchedTheme = true;
}

// –ú–µ—Ç–æ–¥ –æ—á–∏—Å—Ç–∫–∏ (–Ω–∞ —Å–ª—É—á–∞–π HMR/–ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏)
window.__milk2048_themeAudio.cleanup = function(){
  try { 
    Object.values(themeSounds).forEach(s=>{
      if(s.bg) { s.bg.pause(); s.bg.src=''; }
      if(s.move) { s.move.src=''; }
    }); 
  } catch(e){}
  window.__milk2048_themeAudio = undefined;
};

// === ENABLE SOUND ON FIRST CLICK ===
let __audioUnlocked = false;
function enableAudioOnce() {
  if(__audioUnlocked) return;
  __audioUnlocked = true;
  try {
    const theme = (localStorage.getItem('milk2048_theme') || 'default');
    if (theme !== 'default') {
      playThemeSound(theme);
    }
    Object.values(themeSounds).forEach(s => {
      if(s.bg) {
        s.bg.muted = false;
        // Prime audio to satisfy autoplay policies
        try { s.bg.play().then(()=>{ s.bg.pause(); s.bg.currentTime = 0; }).catch(()=>{}); } catch(e){}
      }
      if(s.move) {
        s.move.muted = false;
        try { s.move.play().then(()=>{ s.move.pause(); s.move.currentTime = 0; }).catch(()=>{}); } catch(e){}
      }
    });
  } catch(e) {}
  console.log('üîä Audio unlocked by user gesture');
}
document.addEventListener('click', enableAudioOnce, { once: true });
document.addEventListener('touchstart', enableAudioOnce, { once: true });

</script>
</body>
</html>

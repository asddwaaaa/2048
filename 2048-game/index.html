<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2048 - Premium Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Default Theme */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-overlay: rgba(255, 255, 255, 0.95);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #2d3436;
            --text-light: #ffffff;
            --accent: #667eea;
            --grid-bg: rgba(0, 0, 0, 0.05);
            --cell-bg: rgba(0, 0, 0, 0.1);
            
            /* Tile gradients */
            --tile-2: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            --tile-4: linear-gradient(135deg, #ffecb3 0%, #ffd54f 100%);
            --tile-8: linear-gradient(135deg, #ffb74d 0%, #ff9800 100%);
            --tile-16: linear-gradient(135deg, #ff7043 0%, #ff5722 100%);
            --tile-32: linear-gradient(135deg, #ec407a 0%, #e91e63 100%);
            --tile-64: linear-gradient(135deg, #ab47bc 0%, #9c27b0 100%);
            --tile-128: linear-gradient(135deg, #7e57c2 0%, #673ab7 100%);
            --tile-256: linear-gradient(135deg, #5c6bc0 0%, #3f51b5 100%);
            --tile-512: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
            --tile-1024: linear-gradient(135deg, #26c6da 0%, #00bcd4 100%);
            --tile-2048: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
            --tile-super: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-overlay: rgba(30, 30, 40, 0.95);
                --text-primary: #ffffff;
                --grid-bg: rgba(255, 255, 255, 0.05);
                --cell-bg: rgba(255, 255, 255, 0.08);
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            width: 100%;
            position: relative;
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 8px;
            border: 1px solid var(--glass-border);
        }

        .nav-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-weight: 600;
            font-size: 14px;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.6;
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.2);
            opacity: 1;
        }

        .nav-btn:hover {
            opacity: 1;
        }

        /* Screens */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        .title {
            font-size: 56px;
            font-weight: 900;
            color: var(--text-light);
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            letter-spacing: -2px;
        }

        .stats {
            display: flex;
            gap: 12px;
        }

        .stat-box {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            padding: 12px 18px;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            min-width: 90px;
            text-align: center;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-light);
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 900;
            color: var(--text-light);
        }

        /* Game Board */
        .game-board {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 15px;
            border-radius: 24px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            background: var(--grid-bg);
            padding: 12px;
            border-radius: 18px;
            position: relative;
            aspect-ratio: 1;
        }

        .cell {
            background: var(--cell-bg);
            border-radius: 12px;
            aspect-ratio: 1;
        }

        .tiles {
            position: absolute;
            top: 12px;
            left: 12px;
            right: 12px;
            bottom: 12px;
            pointer-events: none;
        }

        .tile {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-weight: 900;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .tile.new {
            animation: tileAppear 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .tile.merged {
            animation: tileMerge 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes tileAppear {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes tileMerge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .tile-2 { background: var(--tile-2); color: #776e65; }
        .tile-4 { background: var(--tile-4); color: #776e65; }
        .tile-8 { background: var(--tile-8); }
        .tile-16 { background: var(--tile-16); }
        .tile-32 { background: var(--tile-32); }
        .tile-64 { background: var(--tile-64); }
        .tile-128 { background: var(--tile-128); }
        .tile-256 { background: var(--tile-256); }
        .tile-512 { background: var(--tile-512); }
        .tile-1024 { background: var(--tile-1024); }
        .tile-2048 { background: var(--tile-2048); }
        .tile-super { background: var(--tile-super); }

        /* Controls */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            color: var(--text-light);
            font-weight: 700;
            font-size: 13px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Shop */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .shop-item {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .shop-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
        }

        .shop-preview {
            width: 100%;
            height: 100px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .shop-name {
            font-weight: 700;
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .shop-price {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 16px;
            font-weight: 900;
            color: var(--text-light);
        }

        .shop-item.owned {
            border-color: #4caf50;
        }

        .shop-item.active {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .shop-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            color: white;
        }

        /* Settings */
        .settings-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 15px;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 15px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            color: var(--text-light);
            font-weight: 600;
        }

        .setting-value {
            color: var(--text-light);
            opacity: 0.7;
            font-size: 14px;
        }

        /* Overlay */
        .overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--bg-overlay);
            padding: 40px 35px;
            border-radius: 28px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal h2 {
            font-size: 36px;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .modal p {
            color: var(--text-primary);
            opacity: 0.8;
            margin-bottom: 25px;
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            background: var(--accent);
            color: white;
            font-weight: 700;
            border-radius: 14px;
            cursor: pointer;
            font-size: 14px;
        }

        .modal-btn.secondary {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }

        @media (max-width: 600px) {
            .title {
                font-size: 42px;
            }

            .stats {
                flex-direction: column;
                gap: 8px;
            }

            .stat-box {
                min-width: 0;
            }

            .shop-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <div class="nav">
            <button class="nav-btn active" onclick="switchScreen('game')">üéÆ –ò–≥—Ä–∞</button>
            <button class="nav-btn" onclick="switchScreen('shop')">üíé –ú–∞–≥–∞–∑–∏–Ω</button>
            <button class="nav-btn" onclick="switchScreen('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>

        <!-- Game Screen -->
        <div class="screen active" id="gameScreen">
            <div class="header">
                <div class="title">2048</div>
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-label">–°—á—ë—Ç</div>
                        <div class="stat-value" id="score">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">–õ—É—á—à–∏–π</div>
                        <div class="stat-value" id="best">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">üíé</div>
                        <div class="stat-value" id="crystals">0</div>
                    </div>
                </div>
            </div>

            <div class="game-board">
                <div class="grid" id="grid">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell"></div>
                </div>
                <div class="tiles" id="tiles"></div>
            </div>

            <div class="controls">
                <button class="btn" onclick="game.newGame()">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                <button class="btn" id="undoBtn" onclick="game.undo()">‚Ü©Ô∏è –û—Ç–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>

        <!-- Shop Screen -->
        <div class="screen" id="shopScreen">
            <div class="header">
                <div class="title">–ú–∞–≥–∞–∑–∏–Ω</div>
                <div class="stat-box">
                    <div class="stat-label">üíé –ö—Ä–∏—Å—Ç–∞–ª–ª—ã</div>
                    <div class="stat-value" id="crystalsShop">0</div>
                </div>
            </div>
            <div class="shop-grid" id="shopGrid"></div>
        </div>

        <!-- Settings Screen -->
        <div class="screen" id="settingsScreen">
            <div class="header">
                <div class="title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>

            <div class="settings-section">
                <div class="settings-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div class="setting-item">
                    <span class="setting-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</span>
                    <span class="setting-value" id="gamesPlayed">0</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ 2048</span>
                    <span class="setting-value" id="wins">0</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">–õ—É—á—à–∏–π —Ç–∞–π–ª</span>
                    <span class="setting-value" id="bestTile">2</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
                <div class="setting-item">
                    <span class="setting-label">üèÜ –ü–µ—Ä–≤–æ–µ 2048</span>
                    <span class="setting-value" id="ach1">‚ùå</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">üíØ –ë–µ–∑ –æ—Ç–º–µ–Ω—ã</span>
                    <span class="setting-value" id="ach2">‚ùå</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">üöÄ –î–æ—à—ë–ª –¥–æ 4096</span>
                    <span class="setting-value" id="ach3">‚ùå</span>
                </div>
            </div>

            <button class="btn" onclick="if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')) { localStorage.clear(); location.reload(); }" style="width: 100%; margin-top: 20px;">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        </div>

        <!-- Win Overlay -->
        <div class="overlay" id="winOverlay">
            <div class="modal">
                <h2>üéâ –ü–æ–±–µ–¥–∞!</h2>
                <p>–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ 2048!</p>
                <p style="font-size: 24px; font-weight: 900;">+100 üíé</p>
                <div class="modal-buttons">
                    <button class="modal-btn" onclick="game.continueGame()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                    <button class="modal-btn secondary" onclick="game.newGame(); hideOverlay('winOverlay')">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                </div>
            </div>
        </div>

        <!-- Game Over Overlay -->
        <div class="overlay" id="gameOverOverlay">
            <div class="modal">
                <h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
                <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ö–æ–¥–æ–≤</p>
                <p>–°—á—ë—Ç: <strong id="finalScore">0</strong></p>
                <div class="modal-buttons">
                    <button class="modal-btn" onclick="game.newGame(); hideOverlay('gameOverOverlay')">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Shop items data
        const shopItems = [
            {id: 'default', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', price: 0, type: 'theme', bgGradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'},
            {id: 'cosmic', name: '–ö–æ—Å–º–æ—Å', price: 300, type: 'theme', bgGradient: 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)'},
            {id: 'sakura', name: '–°–∞–∫—É—Ä–∞', price: 500, type: 'theme', bgGradient: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)'},
            {id: 'cyber', name: '–ö–∏–±–µ—Ä–ø–∞–Ω–∫', price: 800, type: 'theme', bgGradient: 'linear-gradient(135deg, #ff00cc 0%, #333399 100%)'},
            {id: 'lava', name: '–õ–∞–≤–∞', price: 600, type: 'theme', bgGradient: 'linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%)'},
            {id: 'ocean', name: '–û–∫–µ–∞–Ω', price: 400, type: 'theme', bgGradient: 'linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%)'},
            {id: 'forest', name: '–õ–µ—Å', price: 450, type: 'theme', bgGradient: 'linear-gradient(135deg, #134e5e 0%, #71b280 100%)'},
            {id: 'sunset', name: '–ó–∞–∫–∞—Ç', price: 550, type: 'theme', bgGradient: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'},
            {id: 'aurora', name: '–ê–≤—Ä–æ—Ä–∞', price: 900, type: 'theme', bgGradient: 'linear-gradient(135deg, #00c6ff 0%, #0072ff 100%)'},
            {id: 'neon', name: '–ù–µ–æ–Ω', price: 1200, type: 'theme', bgGradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'},
        ];

        // Game State
        class Game2048 {
            constructor() {
                this.size = 4;
                this.grid = [];
                this.score = 0;
                this.best = parseInt(localStorage.getItem('best2048')) || 0;
                this.crystals = parseInt(localStorage.getItem('crystals')) || 0;
                this.won = false;
                this.gameOver = false;
                this.undoStack = [];
                this.maxUndos = 3;
                this.tileId = 0;
                this.stats = JSON.parse(localStorage.getItem('stats')) || {
                    gamesPlayed: 0,
                    wins: 0,
                    bestTile: 2
                };
                this.achievements = JSON.parse(localStorage.getItem('achievements')) || {
                    first2048: false,
                    noUndo: false,
                    reached4096: false
                };
                this.init();
            }

            init() {
                this.initGrid();
                this.addRandomTile();
                this.addRandomTile();
                this.render();
                this.updateUI();
                this.setupControls();
                this.stats.gamesPlayed++;
                this.saveStats();
            }

            initGrid() {
                this.grid = Array(this.size).fill(null).map(() => Array(this.size).fill(null));
            }

            setupControls() {
                document.addEventListener('keydown', (e) => {
                    if (this.gameOver) return;
                    const key = e.key.toLowerCase();
                    if (['arrowup', 'w'].includes(key)) { e.preventDefault(); this.move('up'); }
                    else if (['arrowdown', 's'].includes(key)) { e.preventDefault(); this.move('down'); }
                    else if (['arrowleft', 'a'].includes(key)) { e.preventDefault(); this.move('left'); }
                    else if (['arrowright', 'd'].includes(key)) { e.preventDefault(); this.move('right'); }
                });

                let touchStartX = 0, touchStartY = 0;
                const grid = document.getElementById('grid');
                grid.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                }, { passive: true });

                grid.addEventListener('touchend', (e) => {
                    if (this.gameOver) return;
                    const dx = e.changedTouches[0].clientX - touchStartX;
                    const dy = e.changedTouches[0].clientY - touchStartY;
                    const threshold = 30;

                    if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > threshold) {
                        this.move(dx > 0 ? 'right' : 'left');
                    } else if (Math.abs(dy) > threshold) {
                        this.move(dy > 0 ? 'down' : 'up');
                    }
                }, { passive: true });
            }

            addRandomTile() {
                const empty = [];
                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        if (!this.grid[r][c]) empty.push({r, c});
                    }
                }
                if (empty.length > 0) {
                    const {r, c} = empty[Math.floor(Math.random() * empty.length)];
                    this.grid[r][c] = {
                        value: Math.random() < 0.9 ? 2 : 4,
                        id: this.tileId++,
                        isNew: true,
                        merged: false
                    };
                }
            }

            saveState() {
                if (this.undoStack.length >= this.maxUndos) this.undoStack.shift();
                this.undoStack.push({
                    grid: JSON.parse(JSON.stringify(this.grid)),
                    score: this.score
                });
            }

            undo() {
                if (this.undoStack.length > 0) {
                    const state = this.undoStack.pop();
                    this.grid = state.grid;
                    this.score = state.score;
                    this.render();
                    this.updateUI();
                }
            }

            move(direction) {
                this.saveState();
                let moved = false;
                const traversals = this.getTraversals(direction);

                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        if (this.grid[r][c]) {
                            this.grid[r][c].merged = false;
                            this.grid[r][c].isNew = false;
                        }
                    }
                }

                traversals.rows.forEach(r => {
                    traversals.cols.forEach(c => {
                        const tile = this.grid[r][c];
                        if (tile) {
                            const farthest = this.findFarthest(r, c, direction);
                            const next = this.getNext(farthest.r, farthest.c, direction);
                            
                            if (next.r >= 0 && next.r < this.size && next.c >= 0 && next.c < this.size &&
                                this.grid[next.r][next.c] && this.grid[next.r][next.c].value === tile.value &&
                                !this.grid[next.r][next.c].merged) {
                                
                                this.grid[next.r][next.c] = {
                                    value: tile.value * 2,
                                    id: this.tileId++,
                                    merged: true,
                                    isNew: false
                                };
                                this.grid[r][c] = null;
                                this.score += tile.value * 2;
                                moved = true;

                                if (tile.value * 2 > this.stats.bestTile) {
                                    this.stats.bestTile = tile.value * 2;
                                }
                            } else if (farthest.r !== r || farthest.c !== c) {
                                this.grid[farthest.r][farthest.c] = tile;
                                this.grid[r][c] = null;
                                moved = true;
                            }
                        }
                    });
                });

                if (moved) {
                    this.addRandomTile();
                    this.render();
                    this.updateUI();
                    
                    if (!this.won) this.checkWin();
                    this.checkGameOver();
                } else {
                    this.undoStack.pop();
                }
            }

            getTraversals(direction) {
                const rows = [0, 1, 2, 3];
                const cols = [0, 1, 2, 3];
                if (direction === 'down') rows.reverse();
                if (direction === 'right') cols.reverse();
                return { rows, cols };
            }

            findFarthest(r, c, direction) {
                let prev = {r, c};
                let next = this.getNext(r, c, direction);
                
                while (next.r >= 0 && next.r < this.size && next.c >= 0 && next.c < this.size && !this.grid[next.r][next.c]) {
                    prev = next;
                    next = this.getNext(next.r, next.c, direction);
                }
                return prev;
            }

            getNext(r, c, direction) {
                const vectors = {
                    up: {r: -1, c: 0},
                    down: {r: 1, c: 0},
                    left: {r: 0, c: -1},
                    right: {r: 0, c: 1}
                };
                const v = vectors[direction];
                return {r: r + v.r, c: c + v.c};
            }

            checkWin() {
                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        if (this.grid[r][c]?.value === 2048) {
                            this.won = true;
                            this.stats.wins++;
                            this.crystals += 100;
                            if (!this.achievements.first2048) {
                                this.achievements.first2048 = true;
                                this.crystals += 50;
                            }
                            this.saveStats();
                            this.saveCrystals();
                            this.saveAchievements();
                            showOverlay('winOverlay');
                            return;
                        }
                        if (this.grid[r][c]?.value === 4096 && !this.achievements.reached4096) {
                            this.achievements.reached4096 = true;
                            this.crystals += 200;
                            this.saveAchievements();
                            this.saveCrystals();
                        }
                    }
                }
            }

            checkGameOver() {
                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        if (!this.grid[r][c]) return;
                    }
                }

                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        const val = this.grid[r][c].value;
                        if ((c < this.size - 1 && this.grid[r][c + 1]?.value === val) ||
                            (r < this.size - 1 && this.grid[r + 1][c]?.value === val)) {
                            return;
                        }
                    }
                }

                this.gameOver = true;
                document.getElementById('finalScore').textContent = this.score;
                showOverlay('gameOverOverlay');
            }

            continueGame() {
                hideOverlay('winOverlay');
            }

            newGame() {
                this.grid = [];
                this.score = 0;
                this.won = false;
                this.gameOver = false;
                this.undoStack = [];
                this.init();
            }

            getCellPosition(r, c) {
                const gridEl = document.getElementById('grid');
                const rect = gridEl.getBoundingClientRect();
                const cellSize = (rect.width - 24 - 36) / 4;
                return {
                    left: c * (cellSize + 12),
                    top: r * (cellSize + 12),
                    size: cellSize
                };
            }

            render() {
                const tilesEl = document.getElementById('tiles');
                tilesEl.innerHTML = '';

                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        const tile = this.grid[r][c];
                        if (tile) {
                            const pos = this.getCellPosition(r, c);
                            const tileEl = document.createElement('div');
                            tileEl.className = `tile tile-${tile.value}`;
                            if (tile.isNew) tileEl.classList.add('new');
                            if (tile.merged) tileEl.classList.add('merged');
                            
                            tileEl.style.left = `${pos.left}px`;
                            tileEl.style.top = `${pos.top}px`;
                            tileEl.style.width = `${pos.size}px`;
                            tileEl.style.height = `${pos.size}px`;
                            tileEl.style.fontSize = tile.value >= 1024 ? `${pos.size * 0.35}px` : `${pos.size * 0.5}px`;
                            tileEl.textContent = tile.value;
                            
                            tilesEl.appendChild(tileEl);
                        }
                    }
                }
            }

            updateUI() {
                document.getElementById('score').textContent = this.score;
                document.getElementById('best').textContent = this.best;
                document.getElementById('crystals').textContent = this.crystals;
                document.getElementById('crystalsShop').textContent = this.crystals;
                document.getElementById('undoBtn').disabled = this.undoStack.length === 0;

                if (this.score > this.best) {
                    this.best = this.score;
                    localStorage.setItem('best2048', this.best);
                }

                updateSettings();
            }

            saveStats() {
                localStorage.setItem('stats', JSON.stringify(this.stats));
            }

            saveCrystals() {
                localStorage.setItem('crystals', this.crystals);
            }

            saveAchievements() {
                localStorage.setItem('achievements', JSON.stringify(this.achievements));
            }
        }

        // Initialize game
        let game = new Game2048();

        // Screen switching
        function switchScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(screen + 'Screen').classList.add('active');
            event.target.classList.add('active');

            if (screen === 'shop') {
                renderShop();
            }
        }

        // Shop
        function renderShop() {
            const grid = document.getElementById('shopGrid');
            const owned = JSON.parse(localStorage.getItem('ownedThemes')) || ['default'];
            const active = localStorage.getItem('activeTheme') || 'default';

            grid.innerHTML = shopItems.map(item => `
                <div class="shop-item ${owned.includes(item.id) ? 'owned' : ''} ${active === item.id ? 'active' : ''}" onclick="handleShopItem('${item.id}', ${item.price})">
                    ${owned.includes(item.id) ? '<span class="shop-badge">‚úì</span>' : ''}
                    ${active === item.id ? '<span class="shop-badge">‚òÖ</span>' : ''}
                    <div class="shop-preview" style="background: ${item.bgGradient}"></div>
                    <div class="shop-name">${item.name}</div>
                    <div class="shop-price">
                        ${owned.includes(item.id) ? '–ö—É–ø–ª–µ–Ω–æ' : `üíé ${item.price}`}
                    </div>
                </div>
            `).join('');
        }

        function handleShopItem(id, price) {
            const owned = JSON.parse(localStorage.getItem('ownedThemes')) || ['default'];
            
            if (owned.includes(id)) {
                applyTheme(id);
            } else {
                if (game.crystals >= price) {
                    game.crystals -= price;
                    owned.push(id);
                    localStorage.setItem('ownedThemes', JSON.stringify(owned));
                    game.saveCrystals();
                    applyTheme(id);
                    renderShop();
                    game.updateUI();
                } else {
                    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤!');
                }
            }
        }

        function applyTheme(id) {
            const item = shopItems.find(i => i.id === id);
            if (item) {
                document.body.style.background = item.bgGradient;
                localStorage.setItem('activeTheme', id);
                renderShop();
            }
        }

        // Load active theme on start
        const activeTheme = localStorage.getItem('activeTheme') || 'default';
        applyTheme(activeTheme);

        // Settings
        function updateSettings() {
            document.getElementById('gamesPlayed').textContent = game.stats.gamesPlayed;
            document.getElementById('wins').textContent = game.stats.wins;
            document.getElementById('bestTile').textContent = game.stats.bestTile;
            document.getElementById('ach1').textContent = game.achievements.first2048 ? '‚úÖ' : '‚ùå';
            document.getElementById('ach2').textContent = game.achievements.noUndo ? '‚úÖ' : '‚ùå';
            document.getElementById('ach3').textContent = game.achievements.reached4096 ? '‚úÖ' : '‚ùå';
        }

        // Overlay functions
        function showOverlay(id) {
            document.getElementById(id).classList.add('active');
        }

        function hideOverlay(id) {
            document.getElementById(id).classList.remove('active');
        }

        updateSettings();
    </script>
</body>
</html>
